---
title: "ALE_final_output"
author: "Kenzie Cooke"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#include = FALSE omits code chunks and results from showing up in html

#knitr::opts_chunk$set to set global opts that apply to all chunks
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

#echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures.

#message = FALSE prevents messages that are generated by code from appearing in the finished file.

#warning = FALSE prevents warnings that are generated by code from appearing in the finished.

#fig.cap = "..." adds a caption to graphical results

```

```{r libraries}

library(ggplot2)
library(dplyr)
library(nlstools)
library(seacarb)
library(emmeans)
library(broom)
library(lmerTest)
library(tidyr)
library(patchwork)
library(ggsignif)
library(ggpubr)
```


## Bottle sample data curation
### Import/filter data
```{r}


# Read the original raw data
forseacarb_raw <- read.csv('data2/bottle_raw.csv', stringsAsFactors = TRUE)


# Filter out samples where delta > 5, precip == "yes", and missing DIC
forseacarb_filtered <- forseacarb_raw %>%
  filter(!delta >= 5) %>%
  filter(!precip == "yes") %>%
  filter(!is.na(DIC) & DIC != "")

# Run seacarb to compute carbonate chemistry
seacarb.output.all = carb(
  flag = 15,
  var1 = forseacarb_filtered$Avg.TA / 10^6,  # Convert TA from umol/kg to mol/kg
  var2 = forseacarb_filtered$DIC / 10^6,  # Convert DIC from umol/kg to mol/kg
  S = forseacarb_filtered$Salinity,  # Salinity (psu)
  T = forseacarb_filtered$temp,  # Temperature (°C)
  P = forseacarb_filtered$dbar / 10  # Pressure (bar)
)

# Add pCO2 results to the filtered dataframe
forseacarb_filtered <- forseacarb_filtered %>%
  mutate(
    pCO2 = seacarb.output.all$pCO2,
    pco1000 = ifelse(pCO2 > 1000, "yes", "no"),
    pco2000 = ifelse(pCO2 > 2000, "yes", "no"),
    pco5000 = ifelse(pCO2 > 5000, "yes", "no")
  )

# Extract only the columns needed for merging
pco2_data <- forseacarb_filtered %>%
  dplyr::select(sample_id, pCO2, pco1000, pco2000, pco5000)

# Merge pCO2 columns back into the original dataset (including missing dic rows)
bottle_all <- forseacarb_raw %>%
  filter(!delta >= 5)%>%
  filter(!precip == "yes")%>%
  left_join(pco2_data, by = "sample_id")


```

### Filtered chem datasets
```{r}

#create separate datasets using highest pCO2 value as a cutoff
bottle_1000 <- bottle_all %>%
  filter(pco1000 != 'yes' | is.na(pco1000))

bottle_2000 <- bottle_all %>%
  filter(pco2000 != 'yes' | is.na(pco2000))

bottle_5000 <- bottle_all %>%
  filter(pco5000 != 'yes' | is.na(pco5000))

#create filtered data for before Feb 7th, first half, and second half of experiment

bottle_feb7 <- bottle_all %>%
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%  # Ensure proper conversion
  filter(Date >= as.Date("2024-02-07"))%>%
  filter(pco1000 != "yes"| is.na(pco1000))

bottle_t1t2 <- bottle_all %>%
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
  filter(Date <= as.Date("2024-03-08"))%>%
  filter(pco2000 != 'yes'|is.na(pco2000))

bottle_t2t3 <- bottle_all %>%
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
  filter(Date >= as.Date("2024-03-08"))%>%
  filter(pco2000 != 'yes'|is.na(pco2000))

```
### Coral TA stats
Generate mean, sd, sem TA for each coral 
```{r, results = "hide"}


#Calculate the average ta, standard deviation and standard error for each coral across all dates
ta_coral_all <- bottle_all %>%
  group_by(Coral) %>%
  summarise(
     n = sum(!is.na(Avg.TA)),  # Count of non-NA values
    avg_ta = mean(Avg.TA, na.rm = TRUE),
    ta_sd = sd(Avg.TA, na.rm = TRUE),
    ta_se = sd(Avg.TA, na.rm = TRUE) / sqrt(n())
  )

#filtering by different pco2 cutoffs, first versus second half of experiment
ta_coral_1000 <- bottle_1000 %>%
  group_by(Coral) %>%
  summarise(
     n = sum(!is.na(Avg.TA)),  # Count of non-NA values
    avg_ta = mean(Avg.TA, na.rm = TRUE),
    ta_sd = sd(Avg.TA, na.rm = TRUE),
    ta_se = sd(Avg.TA, na.rm = TRUE) / sqrt(n())
  )

ta_coral_2000 <- bottle_2000 %>%
  group_by(Coral) %>%
  summarise(
    n = sum(!is.na(Avg.TA)),  # Count of non-NA values
    avg_ta = mean(Avg.TA, na.rm = TRUE),
    ta_sd = sd(Avg.TA, na.rm = TRUE),
    ta_se = sd(Avg.TA, na.rm = TRUE) / sqrt(n())
  )

ta_coral_5000 <- bottle_5000 %>%
  group_by(Coral) %>%
  summarise(
    n = sum(!is.na(Avg.TA)),  # Count of non-NA values
    avg_ta = mean(Avg.TA, na.rm = TRUE),
    ta_sd = sd(Avg.TA, na.rm = TRUE),
    ta_se = sd(Avg.TA, na.rm = TRUE) / sqrt(n())
  )

ta_coral_feb7 <- bottle_feb7 %>%
  group_by(Coral) %>%
  summarise(
    n = sum(!is.na(Avg.TA)),  # Count of non-NA values
    avg_ta = mean(Avg.TA, na.rm = TRUE),
    ta_sd = sd(Avg.TA, na.rm = TRUE),
    ta_se = sd(Avg.TA, na.rm = TRUE) / sqrt(n())
  )

ta_coral_t1t2 <- bottle_t1t2 %>%
  group_by(Coral) %>%
  summarise(
    n = sum(!is.na(Avg.TA)),  # Count of non-NA values
    avg_ta = mean(Avg.TA, na.rm = TRUE),
    ta_sd = sd(Avg.TA, na.rm = TRUE),
    ta_se = sd(Avg.TA, na.rm = TRUE) / sqrt(n())
  )

ta_coral_t2t3 <- bottle_t2t3 %>%
  group_by(Coral) %>%
  summarise(
    n = sum(!is.na(Avg.TA)),  # Count of non-NA values
    avg_ta = mean(Avg.TA, na.rm = TRUE),
    ta_sd = sd(Avg.TA, na.rm = TRUE),
    ta_se = sd(Avg.TA, na.rm = TRUE) / sqrt(n())
  )


```
### Growth dataframes
Import ta stats from above filtered data sets into growth dataframes. Create four based on different filtering of chem data. 

```{r}

growth_raw <- read.csv('data2/growth_raw.csv', stringsAsFactors = TRUE)
# NOTE: This script uses pre-calculated growth rates from growth_raw.csv.
# Raw measurements are provided separately for reproducibility (see README).

# Merge TA statistics into growth data by coral
growth_all <- growth_raw %>%
  left_join(ta_coral_all, by = "Coral")

growth_all$avg_ta_mmol<-growth_all$avg_ta/1000
growth_all$ta_sd_mmol<-growth_all$ta_sd/1000
growth_all$ta_se_mmol<-growth_all$ta_se/1000
# Create new variable. I converted umol to mmol since the slopes were 0.00 something when the [ta] were in the order of thousands. #avg_ta_mmol will be used in all teh linear models 

# pco1000
growth_1000 <- growth_raw %>%
  left_join(ta_coral_1000, by = "Coral")

growth_1000$avg_ta_mmol<-growth_1000$avg_ta/1000
growth_1000$ta_sd_mmol<-growth_1000$ta_sd/1000
growth_1000$ta_se_mmol<-growth_1000$ta_se/1000

#pco2000
growth_2000 <- growth_raw %>%
  left_join(ta_coral_2000, by = "Coral")

growth_2000$avg_ta_mmol<-growth_2000$avg_ta/1000
growth_2000$ta_sd_mmol<-growth_2000$ta_sd/1000
growth_2000$ta_se_mmol<-growth_2000$ta_se/1000

#pco5000
growth_5000 <- growth_raw %>%
  left_join(ta_coral_5000, by = "Coral")

growth_5000$avg_ta_mmol<-growth_5000$avg_ta/1000
growth_5000$ta_sd_mmol<-growth_5000$ta_sd/1000
growth_5000$ta_se_mmol<-growth_5000$ta_se/1000

#filter samples before feb 16
growth_feb7 <- growth_raw %>%
  left_join(ta_coral_feb7, by = "Coral")

growth_feb7$avg_ta_mmol<-growth_feb7$avg_ta/1000
growth_feb7$ta_sd_mmol<-growth_feb7$ta_sd/1000
growth_feb7$ta_se_mmol<-growth_feb7$ta_se/1000

#t1t2
growth_t1t2 <- growth_raw %>%
  left_join(ta_coral_t1t2, by = "Coral")

growth_t1t2$avg_ta_mmol<-growth_t1t2$avg_ta/1000
growth_t1t2$ta_sd_mmol<-growth_t1t2$ta_sd/1000
growth_t1t2$ta_se_mmol<-growth_t1t2$ta_se/1000


#t2t3
growth_t2t3 <- growth_raw %>%
  left_join(ta_coral_t2t3, by = "Coral")

growth_t2t3$avg_ta_mmol<-growth_t2t3$avg_ta/1000
growth_t2t3$ta_sd_mmol<-growth_t2t3$ta_sd/1000
growth_t2t3$ta_se_mmol<-growth_t2t3$ta_se/1000


```

### DECIDE CUTOFF for PCO2 values
Choose which data sets to use for all figures and tables. Carb chem data excludes bottle samples with deltas >5, with precipitaiton, and with Seacarb generated pco2 values greater than the cutoff chosen above.  We have chosen 2000
```{r}
bottle_d <- bottle_2000
grdata <- growth_2000
```


##  Seacarb output    
Carb chem parameters generated using seacarb with measured DIC and TA values.   

### Coral beakers
Generate seacarb parameters for beakers with corals by treatment

```{r}

#sort data by treatment, exclude blanks
amb_d <- bottle_d[bottle_d$Treatment == "AMB" & bottle_d$Coral != "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.amb = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = amb_d$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = amb_d$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = amb_d$Salinity,
 
  #temperature, in deg C
  T = amb_d$temp,
 
  #pressure, need to convert from dbar to bar
  P = amb_d$dbar/ 10
)

#Elevated treatment
elev_d <- bottle_d[bottle_d$Treatment == "ELEV" &  bottle_d$Coral != "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.elev = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = elev_d$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = elev_d$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = elev_d$Salinity,
 
  #temperature, in deg C
  T = elev_d$temp,
 
  #pressure, need to convert from dbar to bar
  P = elev_d$dbar/ 10
)

#High Treatment
hi_d <- bottle_d[bottle_d$Treatment == "HI" & bottle_d$Coral != "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.hi = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = hi_d$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = hi_d$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = hi_d$Salinity,
 
  #temperature, in deg C
  T = hi_d$temp,
 
  #pressure, need to convert from dbar to bar
  P = hi_d$dbar/ 10
)

#Extra high treatment
xhi_d <- bottle_d[bottle_d$Treatment == "XHI" & bottle_d$Coral != "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.xhi = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = xhi_d$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = xhi_d$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = xhi_d$Salinity,
 
  #temperature, in deg C
  T = xhi_d$temp,
 
  #pressure, need to convert from dbar to bar
  P = xhi_d$dbar/ 10
)

```

### Blank Beakers
Generate seacarb parameters for blank beakers by treatment
```{r}
#Now do seacarb parameters for Blanks 
#sort data by treatment 
amb_blank <- bottle_d[bottle_d$Treatment == "AMB" & bottle_d$Coral == "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.amb_blank = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = amb_blank$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = amb_blank$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = amb_blank$Salinity,
 
  #temperature, in deg C
  T = amb_blank$temp,
 
  #pressure, need to convert from dbar to bar
  P = amb_blank$dbar/ 10
)

#Elevated treatment
elev_blank <- bottle_d[bottle_d$Treatment == "ELEV" &  bottle_d$Coral == "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.elev.blank = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = elev_blank$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = elev_blank$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = elev_blank$Salinity,
 
  #temperature, in deg C
  T = elev_blank$temp,
 
  #pressure, need to convert from dbar to bar
  P = elev_blank$dbar/ 10
)

#High Treatment
hi_blank <- bottle_d[bottle_d$Treatment == "HI" & bottle_d$Coral == "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.hi.blank = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = hi_blank$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = hi_blank$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = hi_blank$Salinity,
 
  #temperature, in deg C
  T = hi_blank$temp,
 
  #pressure, need to convert from dbar to bar
  P = hi_blank$dbar/ 10
)

#Extra high treatment
xhi_blank <- bottle_d[bottle_d$Treatment == "XHI" & bottle_d$Coral == "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.xhi.blank = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = xhi_blank$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = xhi_blank$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = xhi_blank$Salinity,
 
  #temperature, in deg C
  T = xhi_blank$temp,
 
  #pressure, need to convert from dbar to bar
  P = xhi_blank$dbar/ 10
)
```
### Seacarb stats by treatment  
Create stats with  mean, sd, and SEM for all parameters grouped by treatment (corals and empty beakers separate)

```{r}
stats_amb <- seacarb.output.amb %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )
stats_amb_blank <- seacarb.output.amb_blank %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )


# elevated
stats_elev <- seacarb.output.elev %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )
stats_elev_blank <- seacarb.output.elev.blank %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )

#high
stats_hi <- seacarb.output.hi %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )
stats_hi_blank <- seacarb.output.hi.blank %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )


#xhi
stats_xhi <- seacarb.output.xhi %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )
stats_xhi_blank <- seacarb.output.xhi.blank %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )


```

### Create Seacarb Table
Export stats to carb chem table for manuscript

```{r}
# Load necessary libraries
library(dplyr)
library(tidyr)
library(writexl)

# Add a treatment and type column
stats_amb <- stats_amb %>% mutate(Treatment = "AMB", Type = "Regular")
stats_amb_blank <- stats_amb_blank %>% mutate(Treatment = "AMB", Type = "Blank")

stats_elev <- stats_elev %>% mutate(Treatment = "ELEV", Type = "Regular")
stats_elev_blank <- stats_elev_blank %>% mutate(Treatment = "ELEV", Type = "Blank")

stats_hi <- stats_hi %>% mutate(Treatment = "HI", Type = "Regular")
stats_hi_blank <- stats_hi_blank %>% mutate(Treatment = "HI", Type = "Blank")

stats_xhi <- stats_xhi %>% mutate(Treatment = "XHI", Type = "Regular")
stats_xhi_blank <- stats_xhi_blank %>% mutate(Treatment = "XHI", Type = "Blank")

# Combine all tables
combined_stats <- bind_rows(
  stats_amb, stats_amb_blank,
  stats_elev, stats_elev_blank,
  stats_hi, stats_hi_blank,
  stats_xhi, stats_xhi_blank
)

# Load necessary packages
library(dplyr)
library(tidyr)
library(writexl)
library(flextable)
library(officer)

# Define the variables to keep in the correct orde
vars_to_keep <- c(
  "n", 
  "ALK_mean", "ALK_SEM", 
  "DIC_mean", "DIC_SEM", 
  "pCO2_mean", "pCO2_SEM", 
  "pH_mean", "pH_SEM", 
  "OmegaAragonite_mean", "OmegaAragonite_SEM", 
  "HCO3_mean", "HCO3_SEM", 
  "CO3_mean", "CO3_SEM", 
  "S_mean", "S_SEM"
)

# Filter only the selected variables
stats_filtered <- combined_stats %>%
  pivot_longer(cols = -c(Treatment, Type), 
               names_to = c("Variable"),
               values_to = "Value") %>%
  filter(Variable %in% vars_to_keep)

# Reshape into wide format (treatment as columns, mean & SEM under each)
stats_wide <- stats_filtered %>%
  pivot_wider(names_from = Treatment, 
              values_from = Value,
              names_glue = "{Treatment}_{.value}")

# Ensure columns match the desired output format
col_order <- c("Variable", "Type", 
               "AMB", "AMB_SEM", 
               "ELEV", "ELEV_SEM", 
               "HI", "HI_SEM", 
               "XHI", "XHI_SEM")

# Rename columns for clarity
colnames(stats_wide) <- gsub("_mean", "", colnames(stats_wide))
colnames(stats_wide) <- gsub("_SEM", " SEM", colnames(stats_wide))

# Arrange the data in the correct order
stats_wide <- stats_wide %>%
  arrange(match(Variable, vars_to_keep))


print(stats_wide)

```
## Statistics
### Treatment~TA ANOVA  

Was alkalinity statistically different between treatments?   

```{r}

#install.packages('multcomp')# install multcomp before!
#install.packages('multcompView')
library(multcomp)
library(multcompView)

treat_aov <- aov(avg_ta_mmol ~ treatment, data = grdata)
summary(treat_aov)

treat_aov_2 <- lm(avg_ta_mmol ~ treatment, data = grdata)
 summary(treat_aov_2)

TAemmean<-cld(emmeans(treat_aov_2, ~treatment), Letters = letters)
TAemmean
pairs(emmeans(treat_aov_2, ~treatment), adjust = "tukey")
#tukey_treat <- cld(TukeyHSD(treat_aov))
#print(tukey_treat)


```

Treatment summaries
```{r}
ta_summary <- bottle_d %>%
  group_by(Treatment) %>%
  summarise(
    mean_ta = mean(Avg.TA),
    sem_ta = sd(Avg.TA) / sqrt(n())
  )
print(ta_summary)
```

### Calcification 
#### Linear models and ANOVA
```{r}
#BW mixed effect linear model 
LM_BWTA2 <- lmerTest::lmer(gr_t1t3 ~ avg_ta_mmol + (1|geno) + (1|tank), data = grdata)
summary(LM_BWTA2)
anova(LM_BWTA2)
ranova(LM_BWTA2)
step(LM_BWTA2)
#plot(LM_BWTA2)
```

no genotype effect
Simplest linear model: 
```{r}
LM_BWTA2a <- lm(gr_t1t3 ~ avg_ta_mmol, data = grdata)
summary(LM_BWTA2a)
anova(LM_BWTA2a)
#plot(LM_BWTA2a)

bw_slope <- coef(LM_BWTA2a)["avg_ta_mmol"]
bw_intercept <- coef(LM_BWTA2a)[1]  # Intercept
bw_summary_model <- summary(LM_BWTA2a)
bw_r_squared <- summary(LM_BWTA2a)$r.squared
bw_pvalue <- summary(LM_BWTA2a)$coefficients[2, 4]


print(paste("R-Squared:", bw_r_squared))
print(paste("slope:", bw_slope))
print(paste("p = ",bw_pvalue))
print(paste("intercept: ",bw_intercept))

```
### Linear Extension 
#### Linear models and ANOVA
```{r}
#LE mixed effect linear model t1-t3
LM_LETA2 <- lmerTest::lmer(le_t1t3e ~ avg_ta_mmol + (1|geno) + (1|tank), data = grdata)
summary(LM_LETA2)
anova(LM_LETA2)
ranova(LM_LETA2)
step(LM_LETA2)
#plot(LM_LETA2)
```


 
no genotype effect  
Simplest linear model: 
```{r}
LM_LETA2a <- lm(le_t1t3e ~ avg_ta_mmol, data = grdata)
summary(LM_LETA2a)
anova(LM_LETA2a)
#plot(LM_LETA2a)

le_slope <- coef(LM_LETA2a)["avg_ta_mmol"]
le_intercept <- coef(LM_LETA2a)[1]  # Intercept
le_summary_model <- summary(LM_LETA2a)
le_r_squared <- summary(LM_LETA2a)$r.squared
le_pvalue <- summary(LM_LETA2a)$coefficients[2, 4]



le_summary_model




print(paste("R-Squared:", le_r_squared))
print(paste("slope:", le_slope))
print(paste("p = ",le_pvalue))
print(paste("intercept: ", le_intercept))
```


## Figures  
### Assign Colors/Generate Treat Names/Label groups  
```{r}
#re-define treatment names HERE
#color pallette to assign treatments 
treatment_colors <- c(
  AMB = "#52dcbf",   # Light blue
  ELEV = "#1fa1d5",  # You can adjust this color
  HI = "#9d3aa6",    # You can adjust this color
  XHI =  "#6b348f"  )  # Coral

#define custom labels for genotype
labels_genotype <- c("C" = "A",
                     "M9" = "B",
                     "SI" = "C")


dose_names <- c("AMB" = "Ambient", "ELEV" = "+1,200", "HI" = "+1,850", "XHI" = "+2,000")

```

### Figure 1 (Treatment TA)
#### TA~treatment (Boxplot) 
```{r}
#boxplot 
 
# Create a summary table for sample sizes
sample_sizes <- bottle_d %>%
  group_by(Treatment) %>%
  summarise(n = n(), 
            lower_whisker = quantile(Avg.TA, 0.25, na.rm = TRUE))  # Get Q1 for placement

y_limits <- c(min(bottle_d$Avg.TA), max(bottle_d$Avg.TA))  # Set y-axis limits

box_ta <- ggplot(bottle_d, aes(x = Treatment, y = Avg.TA, fill = Treatment)) +
  geom_boxplot() +
  ylab(expression(Total~alkalinity ~ (mu*mol~kg^-1))) +
  xlab("Treatment") +
  scale_x_discrete(labels = NULL) +
  scale_y_continuous(labels = scales::comma) +
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  theme(
    axis.title.x = element_text(size = 23),    
    axis.title.y = element_text(size = 23),    
    axis.text = element_text(size = 19),       
    legend.text = element_text(size = 16),     
    legend.title = element_text(size = 18)     
  ) +
  scale_fill_manual(values = treatment_colors, labels = dose_names) +
  labs(colour = expression(Treatment ~ A[ T ]), fill = bquote(atop("Treatment " * A[T], "(" * mu * "mol kg"^{-1} * ")"))
) +

  # Adding "a, b, c" labels above the boxplots
  geom_text(aes(x = "AMB", y = max(bottle_d$Avg.TA[bottle_d$Treatment == "AMB"]), label = "a"), 
            vjust = -0.5, size = 5, color = "black") +
  geom_text(aes(x = "ELEV", y = max(bottle_d$Avg.TA[bottle_d$Treatment == "ELEV"]), label = "b"), 
            vjust = -0.5, size = 5, color = "black") +
  geom_text(aes(x = "HI", y = max(bottle_d$Avg.TA[bottle_d$Treatment == "HI"]), label = "c"), 
            vjust = -0.5, size = 5, color = "black") +
  geom_text(aes(x = "XHI", y = max(bottle_d$Avg.TA[bottle_d$Treatment == "XHI"]), label = "c"), 
            vjust = -0.5, size = 5, color = "black") +

  # Adding "n=xx" inside the lower right of the boxes (Q1 position)
  geom_text(data = sample_sizes, 
            aes(x = Treatment, y = lower_whisker, label = paste0("n=", n)), 
            hjust = 1.1, vjust = 1.2, size = 4.2, color = "black") +

  coord_cartesian(ylim = y_limits)

box_ta


```

#### TA~time (scatter)
```{r}
# Summarize the data to create mean and std dev for each day by treatment
#convert date column to "Date" type.
bottle_d$Date <- as.Date(bottle_d$Date, format = "%m/%d/%Y")

# Get the unique dates from the data
unique_dates <- unique(bottle_d$Date)
summary_data <- bottle_d %>%
  group_by(Date, Treatment) %>%
  summarise(
    mean_ta = mean(Avg.TA),
    se_ta = sd(Avg.TA) / sqrt(n())
  ) %>%
  ungroup()


# Plot the summarized data

treat_stab <- ggplot(bottle_d, aes(x = Date, y = Avg.TA)) +
  # Scatter points: jittered points with color (Treatment) and shape (Coral Type)
  geom_jitter(aes(colour = Treatment), alpha = 0.3) +
  
  # Error bars (Mean ± CI)
  stat_summary(aes(x = Date, y = Avg.TA, colour = Treatment),
               fun.data = "mean_cl_boot", geom = "errorbar", 
               width = 0.2, position = position_dodge(width = 1)) +

  # Mean points (Summary points with Treatment color)
  stat_summary(aes(x = Date, y = Avg.TA, colour = Treatment, fill = Treatment, shape = ifelse(Coral == "Blank", "Blank", "Coral")),
               size = 6, fun.data = "mean_cl_boot", geom = "point",
               position = position_dodge(width = 1)) +

  # X-axis formatting
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d") +
  scale_y_continuous(labels = scales::comma)+
 # ylab(expression(Total~alkalinity ~ (mu*mol~kg^-1))) +
  ylab(NULL)+
  
  # Theme adjustments
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 14),
        axis.title.x = element_text(size = 23),
        axis.title.y = element_text(size = 23),
        axis.text.y = element_text(size = 19),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 17)) +

  # Treatment colors
  scale_colour_manual(values = treatment_colors, labels = dose_names) +
  scale_fill_manual(values = treatment_colors, labels = dose_names) +

  # Shape legend (Triangles for Blanks, Circles for others)
  scale_shape_manual(values = c("Blank" = 1, "Coral" = 16), name = "Beaker content") +

  # Hiding shape from the Treatment legend (only circles show there)
  guides(shape = guide_legend(order = 2), colour = guide_legend(order = 1), fill = "none") +

  # Legends labeling
  labs(colour = bquote(atop("Treatment " * A[T], "(" * mu * "mol kg"^{-1} * ")")), 
       fill = expression(Treatment ~ A[ T ]), 
       shape = "Coral Type") + 

  # Limit y-axis range
  coord_cartesian(ylim = y_limits)

treat_stab

```

#### Final Figure 1 (TA_Summary_Plot)

```{r}

TA_summary_plot <- ggarrange(
  box_ta + theme(legend.position = "none", plot.margin = margin(5, 5, -50, 5)),
  treat_stab + theme(legend.position = "right"),  
  labels = c("a", "b"),
  ncol = 2, nrow = 1, widths = c(2, 4), align = "h",
  font.label = list(size = 23, face = "bold")
)

TA_summary_plot

```


### Figure 2 (Calcification~TA) 
#### stats
```{r}

#Generate group CLD letters
bw_aov <- lm(gr_t1t3 ~ treatment, data = grdata)
 summary(bw_aov)
 
BWemmean<-cld(emmeans(bw_aov, ~treatment), Letters = letters)

BWemmean 

pairs(emmeans(bw_aov, ~treatment), adjust = "tukey")

bwcld <- grdata %>%
  group_by(treatment) %>%
  summarise(max_value = max(gr_t1t3)) %>%
    mutate(
    label = c("a", "b", "b", "b"),
    max_value = if_else(treatment == "HI", 0.87, max_value)  # Manually set max_value for +1750 µm
  )

bwcld
```

#### calcification~treatment (boxplot)
```{r}
#Calc summary boxplot
bw_boxsum <- ggplot(grdata, aes(x=treatment, y=gr_t1t3, fill=treatment))+
  geom_boxplot()+
  ylab(expression(Calcification~rate~(mg~cm^-2~day^-1))) +
  xlab("Treatment")+
  scale_x_discrete(labels = dose_names)+
  theme_classic(base_size = 14)+
  theme(plot.margin=unit(c(1,1,1,1), 'cm'))+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+
   theme(
    axis.title.x = element_text(size = 23),    # Increase X-axis title size
    axis.title.y = element_text(size = 23),    # Increase Y-axis title size
    axis.text = element_text(size = 19),       # Increase axis label text size
    legend.text = element_text(size = 15),     # Optionally adjust legend text size
    legend.title = element_text(size = 17)     # Optionally adjust legend title size
  ) +
  scale_fill_manual(values = treatment_colors, labels = dose_names) +
  scale_x_discrete(labels = NULL)+
  labs(
    colour = expression(Treatment ~ A[T]),
    fill = bquote(atop("Treatment" ~ A[T], "(" ~ mu * "mol kg"^{-1} * ")")),
    shape = "Coral Type"
  ) +
  geom_text(
    data = bwcld,
    aes(x = treatment, y = max_value, label = label),
    vjust = -0.5, size = 5
  )



bw_boxsum
```

#### calcification~TA (regression)
```{r}
#Calculate percent incrase in growth between controls and highest treatment 

mean_bwgr <- grdata %>%
  group_by(treatment) %>%
  summarise(
    mean_value = mean(gr_t1t3, na.rm = TRUE),
    sem = sd(gr_t1t3, na.rm = TRUE) / sqrt(sum(!is.na(gr_t1t3)))
  )

# View the summary
print(mean_bwgr)

# Pull values for AMB and XHI
amb_bwmean <- mean_bwgr %>% filter(treatment == "AMB") %>% pull(mean_value)
xhi_bwmean <- mean_bwgr %>% filter(treatment == "XHI") %>% pull(mean_value)
elev_bwmean <- mean_bwgr %>% filter(treatment == "ELEV") %>% pull(mean_value)
# Calculate percent increase from AMB to XHI
bw_increase_elev <- ((elev_bwmean - amb_bwmean)/ amb_bwmean) *100
bw_increase_xhi <- ((xhi_bwmean - amb_bwmean) / amb_bwmean) * 100

# Print result
bw_increase_elev
bw_increase_xhi


# Create scatter plot 
bw_scat <- ggplot(data = grdata, aes(x = avg_ta, y = gr_t1t3, colour = treatment)) +
  geom_point(size = 3, aes(shape = geno)) +
  geom_smooth(color = 1, method = 'lm', se = TRUE, linetype = "dashed") +
   scale_colour_manual(values = treatment_colors, labels = dose_names ) +  # Use scale_colour_manual to apply treatment_colors
  scale_shape_discrete(labels = labels_genotype) +  # Apply labels to the genotype legend
  xlab(expression(Total~alkalinity ~ (mu*mol~kg^-1))) +
  scale_x_continuous(labels = scales :: comma) +
  ylab(NULL) + 
   labs(
  colour = bquote(atop("Treatment" ~ A[T], "(" * mu * "mol kg"^{-1} * ")"))
,
  fill = expression(Treatment ~ A[T]),
  shape = "Genotype"
)+
  theme_classic(base_size = 14) + 
   theme(
    axis.title.x = element_text(size = 23),# Increase X-axis title size
    axis.title.y = element_text(size = 23),    # Increase Y-axis title size
    axis.text = element_text(size = 19),       # Increase axis label text size
    legend.text = element_text(size = 15),     # Optionally adjust legend text size
    legend.title = element_text(size = 17),
    legend.position = c(0.8, 0.15),
    legend.box = "vertical") +
  guides(
    shape = guide_legend(order = 2),   # Move Genotype to the top
    colour = guide_legend(order = 1)   # Move Treatment below it
  ) +
  
  annotate("text", x = 3020, y = 1.13,
           label = paste("slope =", round(bw_slope, 2), " R² =", round(bw_r_squared, 3), " p < 0.00001"), 
           color = "black", size = 6)


  

bw_scat

```

#### Final figure 2 (Calcification_Summary_Plot)
```{r}

library(ggpubr)  # Ensure ggpubr is loaded
bw_scat <- bw_scat + theme(legend.position = "right")

bw_summary_plot <- ggarrange(
 bw_boxsum + theme(legend.position = "NONE"),
  bw_scat,
  labels = c("a", "b"),
  ncol = 2, nrow = 1, widths = c(2, 4),
  align = "h",
  font.label = list(size = 23, face = "bold")
)

bw_summary_plot
```

### Figure 3 (linear extension~TA)
#### stats
```{r}
#Generate group CLD letters


le_ta <- lm(le_t1t3e ~avg_ta, data = growth_2000)
summary(le_ta)
le_aov <- lm(le_t1t3e ~ treatment, data = growth_all)
summary(le_aov)
 
LEemmean<-cld(emmeans(le_aov, ~treatment), Letters = letters)

LEemmean 

lecld <- grdata %>%
  group_by(treatment) %>%
  summarise(max_value = max(le_t1t3e)) %>%
  mutate(label = c("a", "a", "a", "a"))  # Your specific labels



```

Calculate percent increase between controls and highest treatment
```{r}
#Percent increase between controls and highest treatment 

mean_legr <- grdata %>%
  group_by(treatment) %>%
  summarise(
    mean_value = mean(le_t1t3e, na.rm = TRUE),
    sem = sd(le_t1t3e, na.rm = TRUE) / sqrt(sum(!is.na(le_t1t3e)))
  )


# View the summary
print(mean_legr)

# Pull values for AMB and XHI
amb_lemean <- mean_legr %>% filter(treatment == "AMB") %>% pull(mean_value)
xhi_lemean <- mean_legr %>% filter(treatment == "XHI") %>% pull(mean_value)

# Calculate percent increase from AMB to XHI
le_increase <- ((xhi_lemean - amb_lemean) / amb_lemean) * 100

# Print result
le_increase


```

#### LE~treatment (boxplot)

```{r}
le_box <- ggplot(grdata, aes(x= treatment, y = le_t1t3e, fill = treatment))+
                   geom_boxplot()+
  ylab(expression(Linear~extension~(mm~day^-1))) +
  xlab("Treatment")+
  scale_x_discrete(labels = NULL)+
  theme_classic(base_size = 14)+
  theme(plot.margin=unit(c(1,1,1,1), 'cm'))+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+
   theme(
    axis.title.x = element_text(size = 23),    # Increase X-axis title size
    axis.title.y = element_text(size = 23),    # Increase Y-axis title size
    axis.text = element_text(size = 19),       # Increase axis label text size
    legend.text = element_text(size = 15),     # Optionally adjust legend text size
    legend.title = element_text(size = 17),
    # Optionally adjust legend title size
  ) +
  scale_fill_manual(values = treatment_colors, labels = dose_names)+
  labs(colour = expression(Treatment ~ A[ T ]), fill =  bquote(atop("Treatment" ~ A[T], "(" * mu * "mol kg"^{-1} * ")"))) +
   geom_text(data = lecld, aes(x = treatment, y = max_value, label = label), 
            vjust = -0.5, size = 5)+
   coord_cartesian(ylim = c(min(grdata$le_t1t3e), max(grdata$le_t1t3e)))


le_box
                   
```


#### LE~TA (regression)

```{r}
# Create scatter plot 
le_scat <- ggplot(data = grdata, aes(x = avg_ta, y = le_t1t3e, colour = treatment)) +
  geom_point(size = 3, aes(shape = geno)) +
  geom_smooth(color = 1, method = 'lm', se = TRUE, linetype = "dashed") +
  scale_x_continuous(labels = scales :: comma)+
  scale_colour_manual(values = treatment_colors, labels = dose_names) +  # Use scale_colour_manual to apply treatment_colors
  scale_shape_discrete(labels = labels_genotype) +  # Apply labels to the genotype legend
  xlab(expression(Total~alkalinity ~ (mu*mol~kg^-1))) + 
  ylab(NULL) + 
  labs(colour = bquote(atop("Treatment" ~ A[T], "(" * mu * "mol kg"^{-1} * ")"))
, fill =  expression(Treatment ~ A[ T ]), shape = "Genotype")+
  theme_classic(base_size = 14) +
   theme(
    axis.title.x = element_text(size = 23),    # Increase X-axis title size
    axis.title.y = element_text(size = 23),    # Increase Y-axis title size
    axis.text = element_text(size = 19),       # Increase axis label text size
    legend.text = element_text(size = 15),     # Optionally adjust legend text size
    legend.title = element_text(size = 17),
    legend.position = "right",
    legend.box = "vertical"# Optionally adjust legend title size
  ) +
  guides(
    shape = guide_legend(order = 2),   # Move Genotype to the top
    colour = guide_legend(order = 1)   # Move Treatment below it
  ) +
  coord_cartesian(ylim = c(min(grdata$le_t1t3e), max(grdata$le_t1t3e))) +  # Explicitly set y-axis limits
  annotate("text", x = 3020, y = 0.13, 
           label = paste("slope =", round(le_slope, 2), " R² =", round(le_r_squared, 3), " p =", signif(le_pvalue, 3)), 
           color = "black", size = 6)

le_scat

```

#### Final figure 3
```{r}
#final plot

LE_final <- ggarrange(
  le_box +theme(legend.position = "none"),le_scat + theme(legend.position = "right"),
  ncol = 2, nrow = 1, 
  widths = c(2,4),
  labels = c("a", "b"),
  align = "h",
  font.label = list(size = 23, face = "bold")
)


LE_final
```


### Growth across timepoints -- exploration
growth across timepoints. 

#### growth~first half (regression) 

growth (calcificaiton and linear extension) from timepoint 1 to timepoint 2

##### stats for t1-t2
```{r}

LM_LETAsub1 <- lm(le_t1t2e ~ avg_ta_mmol, data = growth_t1t2)
summary(LM_LETAsub1)
anova(LM_LETAsub1)
#plot(LM_LETAsub1)

le_slope1 <- coef(LM_LETAsub1)["avg_ta_mmol"]
le_intercept1 <- coef(LM_LETAsub1)[1]  # Intercept
le_summary_model1 <- summary(LM_LETAsub1)
le_r_squared1 <- summary(LM_LETAsub1)$r.squared
le_pvalue1 <- summary(LM_LETAsub1)$coefficients[2, 4]



le_summary_model1

#bw t1-t2 stats
LM_BWTAsub1 <- lm(gr_t1t2 ~ avg_ta_mmol, data = growth_t1t2)
summary(LM_BWTAsub1)
anova(LM_BWTAsub1)
#plot(LM_BWTAsub1)

bw_slope1 <- coef(LM_BWTAsub1)["avg_ta_mmol"]
bw_intercept1 <- coef(LM_BWTAsub1)[1]  # Intercept
bw_summary_model1 <- summary(LM_BWTAsub1)
bw_r_squared1 <- summary(LM_BWTAsub1)$r.squared
bw_pvalue1 <- summary(LM_BWTAsub1)$coefficients[2, 4]
```

Percenet increase in LE from t1 to t2
```{r}

#Percent increase in growth 
mean_le1 <- grdata %>%
  group_by(treatment) %>%
  summarise(
    mean_value = mean(le_t1t2e, na.rm = TRUE),
    sem = sd(le_t1t2e, na.rm = TRUE) / sqrt(sum(!is.na(le_t1t2e)))
  )

mean_le1_sd <- grdata %>%
  group_by(treatment) %>%
  summarise(
    mean_value = mean(le_t1t2e, na.rm = TRUE),
    sd_value = sd(le_t1t2e, na.rm = TRUE)
  )
# View the summary
print(mean_le1)

# Pull values for AMB and XHI
amb_le1mean <- mean_le1 %>% filter(treatment == "AMB") %>% pull(mean_value)
xhi_le1mean <- mean_le1 %>% filter(treatment == "XHI") %>% pull(mean_value)
elev_le1mean <- mean_le1 %>% filter(treatment == "ELEV") %>% pull(mean_value)

# Calculate percent increase from AMB to ELEV and AMB to XHI
le1_increase_elev <-  ((elev_le1mean - amb_le1mean) / amb_le1mean) * 100
le1_increase_xhi <- ((xhi_le1mean - amb_le1mean) / amb_le1mean) * 100

# Print result
le1_increase_elev
le1_increase_xhi
```

##### regression plot
```{r}


#Create scatter plot for t1-t2
le_scat1 <- ggplot(data = grdata, aes(x = avg_ta, y = le_t1t2e, colour = treatment)) +
  geom_point(size = 2, aes(shape = geno)) +
  geom_smooth(color = 1, method = 'lm', se = TRUE, linetype = "dashed") +
  scale_colour_manual(values = treatment_colors, labels = dose_names) +  # Use scale_colour_manual to apply treatment_colors
  scale_shape_discrete(labels = labels_genotype) +  # Apply labels to the genotype legend
  xlab(expression(Total~alkalinity ~ (mu*mol~kg^-1))) + 
  ylab(expression(Linear~extension~(mm~day^-1))) + 
  labs(colour = expression(Treatment ~ A[ T ]), fill =  expression(Treatment ~ A[ T ]), shape = "Genotype")+
  theme_classic(base_size = 14) +
   theme(
    axis.title.x = element_text(size = 20),    # Increase X-axis title size
    axis.title.y = element_text(size = 20),    # Increase Y-axis title size
    axis.text = element_text(size = 19),       # Increase axis label text size
    legend.text = element_text(size = 16),     # Optionally adjust legend text size
    legend.title = element_text(size = 18),
    legend.position = c(0.9, 0.15),
    legend.box = "horizontal"# Optionally adjust legend title size
  ) +
  guides(
    shape = guide_legend(order = 2),   # Move Genotype to the top
    colour = guide_legend(order = 1)   # Move Treatment below it
  ) +
  coord_cartesian(ylim = c(min(grdata$le_t1t2e), max(grdata$le_t1t2e))) +  # Explicitly set y-axis limits
  annotate("text", x = 3000, y = 0.23, 
           label = paste("slope =", round(le_slope1, 2), " R² =", round(le_r_squared1, 3), " p =", signif(le_pvalue1, 3)), 
           color = "black", size = 5, fontface = "bold")

le_scat1

```

#### growth second half (regression) 

##### stats
```{r}

#stats for t2-t3

LM_LETAsub2 <- lm(le_t2t3e ~ avg_ta_mmol, data = growth_t2t3)
summary(LM_LETAsub2)
anova(LM_LETAsub2)
#plot(LM_LETAsub2)

le_slope2 <- coef(LM_LETAsub2)["avg_ta_mmol"]
le_intercept2 <- coef(LM_LETAsub2)[1]  # Intercept
le_summary_model2 <- summary(LM_LETAsub2)
le_r_squared2 <- summary(LM_LETAsub2)$r.squared
le_pvalue2 <- summary(LM_LETAsub2)$coefficients[2, 4]



le_summary_model2

#calcification for t2-t3 

LM_BWTAsub2 <- lm(gr_t2t3 ~ avg_ta_mmol, data = growth_t2t3)
summary(LM_BWTAsub2)
anova(LM_BWTAsub2)
#plot(LM_BWTAsub2)

bw_slope2 <- coef(LM_BWTAsub2)["avg_ta_mmol"]
bw_intercept2 <- coef(LM_BWTAsub2)[1]  # Intercept
bw_summary_model2 <- summary(LM_BWTAsub2)
bw_r_squared2 <- summary(LM_BWTAsub2)$r.squared
bw_pvalue2 <- summary(LM_BWTAsub2)$coefficients[2, 4]
```
##### regression
```{r}
#Create scatter plot for t2-t3
le_scat2 <- ggplot(data = grdata, aes(x = avg_ta, y = le_t2t3e, colour = treatment)) +
  geom_point(size = 2, aes(shape = geno)) +
  geom_smooth(color = 1, method = 'lm', se = TRUE, linetype = "dashed") +
  scale_colour_manual(values = treatment_colors, labels = dose_names) +  # Use scale_colour_manual to apply treatment_colors
  scale_shape_discrete(labels = labels_genotype) +  # Apply labels to the genotype legend
  xlab(expression(Total~alkalinity ~ (mu*mol~kg^-1))) + 
  ylab(expression(Linear~extension~(mm~day^-1))) + 
  labs(colour = expression(Treatment ~ A[ T ]), fill =  expression(Treatment ~ A[ T ]), shape = "Genotype")+
  theme_classic(base_size = 14) +
   theme(
    axis.title.x = element_text(size = 23),    # Increase X-axis title size
    axis.title.y = element_text(size = 23),    # Increase Y-axis title size
    axis.text = element_text(size = 19),       # Increase axis label text size
    legend.text = element_text(size = 15),     # Optionally adjust legend text size
    legend.title = element_text(size = 17),
    legend.position = c(0.8, 0.15),
    legend.box = "vertical"# Optionally adjust legend title size
  ) +
  guides(
    shape = guide_legend(order = 2),   # Move Genotype to the top
    colour = guide_legend(order = 1)   # Move Treatment below it
  ) +
  coord_cartesian(ylim = c(min(grdata$le_t2t3e), max(grdata$le_t2t3e))) +  # Explicitly set y-axis limits
  annotate("text", x = 3000, y = -0.5, 
           label = paste("slope =", round(le_slope2, 2), " R² =", round(le_r_squared2, 3), " p =", signif(le_pvalue2, 3)), 
           color = "black", size = 5)


le_scat2

```


### Figure 4 (growth across timepoints)
```{r}
# Find the common y-axis range
y_min <- min(grdata$gr_t1t2, grdata$gr_t2t3, grdata$le_t1t2e, grdata$le_t2t3e, na.rm = TRUE)
y_max <- max(grdata$gr_t1t2, grdata$gr_t2t3, grdata$le_t1t2e, grdata$le_t2t3e, na.rm = TRUE)

# Calcification Rate Plot
bw_grxtime_r <- ggplot(grdata, aes(x = avg_ta, y = gr_t1t2)) +
  geom_smooth(aes(color = "gr_t1t2"), method = 'lm', se = TRUE) +
  geom_smooth(data = grdata, aes(x = avg_ta, y = gr_t2t3, color = "gr_t2t3"), method = 'lm', se = TRUE) +  
  scale_color_manual(name = "Growth period", values = c("gr_t1t2" = "#E6A8B1", "gr_t2t3" = "#B79BAA"), labels = c("Feb. 19 - Mar. 8", "Mar. 8 - Mar. 23")) +
  scale_x_continuous(labels = scales ::comma)+
  xlab(expression(Total~alkalinity ~ (mu*mol~kg^-1))) +
  ylab(expression(Calcification~rate~(mg~cm^2 ^-1~day^-1))) +
 # ylim(y_min, y_max) +  # Set consistent y-axis scale
  theme_classic(base_size = 14) +
  theme(
    axis.title.x = element_text(size = 23),
    axis.title.y = element_text(size = 23),
    axis.text = element_text(size = 19),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 17)
  )+
  annotate("text", x=4500, y=1, label = "***", size = 7)+
  annotate("text", x = 4500, y = 0.615, label = "***", size = 7)+
   annotate("text", x = 2750, y = 0.53,
           label = paste("slope =", round(bw_slope1, 2), " \nR² =", round(bw_r_squared1, 3)), 
           color = "black", size = 5)+ 
 annotate("text", x = 2750, y = 0.15,
           label = paste("slope =", round(bw_slope2, 2), " \nR² =", round(bw_r_squared2, 3)), 
           color = "black", size = 5)


 
bw_grxtime_r
# Linear Extension Plot
le_grxtime_r <- ggplot(grdata, aes(x = avg_ta, y = le_t1t2e)) +
  geom_smooth(aes(color = "le_t1t2e"), method = 'lm', se = TRUE) +
  geom_smooth(data = grdata, aes(x = avg_ta, y = le_t2t3e, color = "le_t2t3e"), method = 'lm', se = FALSE) +  
  scale_color_manual(name = "Growth period", values = c("le_t1t2e" = "#E6A8B1", "le_t2t3e" = "#B79BAA"), labels = c("Feb 19 to Mar 8", "Mar 8 to Mar 23")) +
  scale_x_continuous(labels = scales :: comma)+
  xlab(expression(Total~alkalinity ~ (mu*mol~kg^-1))) +
  ylab(expression(Linear~Extenion~(mm~~day^-1))) +
 # ylim(y_min, y_max) +  # Set consistent y-axis scale
  theme_classic(base_size = 14) +
  theme(
    axis.title.x = element_text(size = 23),
    axis.title.y = element_text(size = 23),
    axis.text = element_text(size = 19),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 17)
  )+
  #annotate("text", x = 4500, y = 0.16, label = paste("p = ",round(le_pvalue1,2)), size = 5)+
  annotate("text", x = 4500, y = 0.155, label = "*", size = 7)+
  annotate("text", x = 4500, y = -0.05, label = "ns", size = 6)+
   annotate("text", x = 2750, y = 0.079,
           label = paste("slope =", round(le_slope1, 2), "\nR² =", round(le_r_squared1, 3)), 
           color = "black", size = 5)+ 
 annotate("text", x = 2750, y = -0.06,
           label = paste("slope =", round(le_slope2, 2), "\nR² =", round(le_r_squared2, 3)), 
           color = "black", size = 5)
le_grxtime_r

# Join Figures with Aligned Y-Axis
library(ggpubr)

# Remove x-axis labels from individual plots
grxtime_r_summary <- ggarrange(
  bw_grxtime_r + 
    theme(legend.position = c(0.2, 0.8),
          axis.title.x = element_blank()),
  
  le_grxtime_r + 
    theme(legend.position = "none",
          axis.title.x = element_blank()),
  
  labels = c("a", "b"),
  font.label = list(size = 23, face = "bold"),
  ncol = 2, nrow = 1, widths = c(2, 2),
  align = "hv"
)

# Add shared x-axis label
library(grid)

grxtime_r_summary <- annotate_figure(
  grxtime_r_summary,
  bottom = grid::textGrob(
    expression("Total alkalinity (" * mu * "mol kg"^{-1} * ")"),
    gp = gpar(fontsize = 23),
    just = "center"
  )
)

grxtime_r_summary

```


### Supplementary Figure 1 (Property-Property Plot)

```{r}
library(tidyverse)
library(seacarb)
library(metR)
library(geomtextpath)
```

#### Data from your T1
Ideal and other modeled data assumes pCO2 of 400 and the +Alk targets with the 1.26:1, 1:0, and 0:1 to compare methods with keeping Alk targets and letting DIC and pCO2 vary.
+0 (2400),
Ideal: 2068.82
Na2CO3 Only: 2068.82
NaHCO3 Only: 2068.82

+15 (3900),
Ideal: 3243.677
Na2CO3 Only: 2818.82
NaHCO3 Only: 3568.82

+30 (5400),
Ideal: 4369.416
Na2CO3 Only: 3568.82
NaHCO3 Only: 5068.82

+45 (6900)
Ideal: 5459.844
Na2CO3 Only: 4318.82
NaHCO3 Only: 6568.82

```{r}
alk_dat <- data.frame(
  treatment = rep(c('Ambient',
                '+1200',
                '+1850',
                '+2000'),4),
  type = c(rep('Actual', 4),
           rep('Ideal',4),
           rep('Na2CO3 Only',4),
           rep('NaHCO3 Only',4)),
  TA = c(# actual values
         2543.5,
         3744.6,
         4540.0,
         4610.9,
         # ideal values
         # Na2CO3 Only Values
         # NaHCO3 Only Values
         rep(c(2400,
           2400 + 1500,
           2400 + 3000,
           2400 + 4500), 3)
         ),
  DIC = c(# actual values
          2185.4,
          3049.8,
          3581.0,
          3736.5,
          # ideal values
          2068.82,
          3243.677,
          4369.416,
          5459.844,
          # Na2CO3 Only Values
          2068.82,
          2818.82,
          3568.82,
          4318.82,
          # NaHCO3 Only Values
          2068.82,
          3568.82,
          5068.82,
          6568.82
          ),
  sal = c(34.40,
          34.24,
          34.31,
          34.60,
          rep(34.39,12))
) %>%
  mutate(carb(flag = 15,
              var1 = TA/10^6,
              var2 = DIC/10^6,
              S = sal,
              T = 27, P = 0, Patm = 1, Pt = 0, Sit = 0)) %>%
  dplyr::select(treatment, type, sal, pH,pCO2,DIC, HCO3:OmegaAragonite) %>%
  mutate(across(c(DIC,ALK, HCO3, CO3,), ~.*10^6))

summary(alk_dat)

```

#### create a range of carb chems surrounding your data
```{r}
# Define range for DIC and TA
DIC_range <- seq(2000, 7000, length.out = 50) # umol/kg
TA_range <- seq(2000, 7000, length.out = 50)  # umol/kg

# Generate grid of DIC and TA
dat <- expand.grid(DIC = DIC_range, TA = TA_range) %>%
# Calculate carbonate chemistry using seacarb (flag=15 means DIC & TA given)
# Assume salinity = 35, temperature = 25°C, pressure = 0 dbar
  mutate(carb(
  flag = 15,
  var1 = TA/10^6,
  var2 = DIC/10^6,
  S = mean(alk_dat$sal), T = 27, P = 0, Patm = 1, Pt = 0, Sit = 0
)) %>%
  dplyr::select(DIC, TA, pH, pCO2, OmegaAragonite) %>%
  mutate(DIC = DIC*10^6)
```

#### Plot the range, overlay your data
```{r, warning=FALSE}
# Plot using ggplot
pp_pco2 <- ggplot(dat, aes(x = DIC, y = TA, fill = pH, z=pCO2)) +
  geom_raster(interpolate = TRUE) +
  scale_fill_gradientn(colours = paletteer::paletteer_c("grDevices::rainbow", 7)) + # 
  geom_contour(
               color = "black", alpha = 0.7, linewidth = 0.6,
               breaks =  c(25,100, 400, 1000, 5000)) +
  # adds pCO2 labels
  geom_textcontour(
                   breaks =  c(25,100,400, 1000, 5000),
                   size = 4, spacing=2.5, gap=TRUE,
                   remove_long = TRUE,
                   vjust=0, hjust=0.4) +
  geom_point(data = alk_dat, aes(DIC, ALK),
             color="darkred", size=3, inherit.aes = F) +
  facet_wrap(~type, scales = "free") + 
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  coord_cartesian(ylim = c(2000, 7000), xlim = c(2000, 6000)) +
  labs(x = expression("Dissolved Inorganic Carbon ("*mu*"mol kg"^{-1}*")"),
       y = expression("Total Alkalinity ("*mu*"mol kg"^{-1}*")"),
       fill = "pH") +
  theme_minimal() +
  theme_minimal() + 
  theme(strip.placement = "inside",
        strip.text.x.top =  element_text(angle = 0,size=12))

pp_pco2
ggsave('./pp-pCO2_kenzie.tiff',
       dpi = 600,
       width = 6,
       height = 5,
       units = "in",
       device = "tiff",
       compression = "lzw")

```

Calculate percent increase in growth between controls and different treatments 
```{r}


#calculate percent increase in le across treatments from t1-t2
mean_let1t2 <- growth_t1t2 %>%
  group_by(treatment) %>%
  summarise(
    mean_value = mean(le_t1t2e, na.rm = TRUE),
    sem = sd(le_t1t2e, na.rm = TRUE) / sqrt(sum(!is.na(le_t1t2e)))
    )
print (mean_let1t2)

# Pull values for AMB and XHI
amb_lemeant1t2 <- mean_let1t2 %>% filter(treatment == "AMB") %>% pull(mean_value)
xhi_lemeant1t2 <- mean_let1t2 %>% filter(treatment == "XHI") %>% pull(mean_value)


# Calculate percent increase from AMB to XHI
let1t2_increase <- ((xhi_lemeant1t2 - amb_lemeant1t2) / amb_lemeant1t2) * 100

print(let1t2_increase)

#calculate percent increase in calcification across treatmentes from t1-t2
mean_bwt1t2 <- growth_t1t2  %>%
  group_by(treatment) %>%
  summarise(mean_value = mean(gr_t1t2, na.rm = TRUE),
            sem = sd(gr_t1t2, na.rm = TRUE) / sqrt(sum(!is.na(gr_t1t2)))
    ) 
print(mean_bwt1t2)

# Pull values for AMB and XHI
amb_bwmeant1t2 <- mean_bwt1t2 %>% filter(treatment == "AMB") %>% pull(mean_value)
xhi_bwmeant1t2 <- mean_bwt1t2 %>% filter(treatment == "XHI") %>% pull(mean_value)


# Calculate percent increase from AMB to XHI
bwt1t2_increase <- ((xhi_bwmeant1t2 - amb_bwmeant1t2) / amb_bwmeant1t2) * 100

print(bwt1t2_increase)
```
## Call Final Figures 
```{r}
#call final figures 

TA_summary_plot
bw_summary_plot
LE_final
grxtime_r_summary
```

```{r}
#save figures 

ggsave("figure1.pdf", plot = TA_summary_plot,
       width = 16, height = 10, units = "in", dpi = 300)

ggsave("figure2.pdf", plot = bw_summary_plot, 
       width = 16, height = 10, units = "in", dpi = 300)

ggsave("figure3.pdf", plot = LE_final,
       width = 16, height = 10, units = "in", dpi = 300)

ggsave("figure4.pdf", plot = grxtime_r_summary,
       width = 16, height = 10, units = "in", dpi = 300)

ggsave("figureS1.pdf", plot = pp_pco2,
       width = 8, height = 7, units = "in", dpi = 600)

```


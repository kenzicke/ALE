---
title: "ALE Data exploration"
author: "Kenzie Cooke"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
#include = FALSE omits code chunks and results from showing up in html

#knitr::opts_chunk$set to set global opts that apply to all chunks
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

#echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures.

#message = FALSE prevents messages that are generated by code from appearing in the finished file.

#warning = FALSE prevents warnings that are generated by code from appearing in the finished.

#fig.cap = "..." adds a caption to graphical results


```

```{r libraries}

library(ggplot2)
library(dplyr)
library(nlstools)
library(seacarb)
library(emmeans)
library(broom)
library(lmerTest)
library(tidyr)
library(patchwork)
library(ggsignif)
library(ggpubr)
```

# Quality Control of carbonate chemistry  

```{r import data}
#import all bottle sample data, unfiltered
carbchem <- read.csv('data2/carbchem.csv', stringsAsFactors = TRUE)

ta_time  <- read.csv('data2/ta_all.csv', stringsAsFactors = TRUE)

```

Alkalinity bottle sample quality. Each sample is run in replicate for quality control. If the replicates are within an acceptable threshold (usually < 5umol difference), then the mean of the replicates is used as the final TA value for that sample. The difference in umol between each replicate (deltas) for all collected samples are plotted below  

## Instrument precision (replicate deltas)    

### AllBottles_delta(umol)
Histogram depicts deltas between replicates of all 526 alkalinity samples collected for from Febuary 7th to March 19th, 2024  

```{r AllBottles_delta}
delta <- ta_time$delta
hist(delta)
```

### Deltas by treatment  

```{r}
#histogram of deltas

hist_treat <-ggplot(ta_time, aes(x=delta))+
  geom_histogram(color="black", fill="white")+
  facet_grid(treat ~ .)

hist_treat


```

### deltas > 5 umol by treatment  

```{r}
# Filter data for delta > 5
filtered_data <- ta_time[ta_time$delta > 5, ]

#histogram of filtered data
hist_filt <- ggplot(filtered_data, aes(x=delta))+
  geom_histogram(color="black", fill="white")+
  facet_grid(treat ~ .)

hist_filt

```

## Precipitation  

### PrecipitatedSamples_treatment  

```{r, fig.cap="number of samples with confirmed visual precipitation in bottles post collection. Not confident that all samples with precipitatin were noted down."}

filter_precip <- ta_time[ta_time$precip != "no",]

#create barplot
bar_precip <- ggplot(filter_precip)+
  geom_bar(aes(x=precip))+
  facet_wrap(treat~.)

bar_precip

```


### Number of samples with suspicious pCO2 values  

Carbchem parameters generated using all bottle samples (DIC and TA)
```{r, fig.cap="Datapoints where computed pCO2 (using DIC and TA in seacarb) produced suspicious values (likely due to visible precipitation in bottle samples post collection)"}

# Recode the precipvalues from discrete to continuous

filtered_dataP <- carbchem[carbchem$precip != "a",]

precip_bar <- ggplot(filtered_dataP, aes(x=precip))+
  geom_bar(color= "black", fill = "white") +
  labs(x="pCO2 > xxxx", y="count") +
  facet_wrap(treat~.) +
  scale_x_discrete(labels = c("b" = ">1000", "c" = ">5000"))

precip_bar
```



## Stability of treatments over time  



```{r}
#convert date column to "Date" type.
ta_time$date <- as.Date(ta_time$date, format = "%m/%d/%Y")

# Get the unique dates from the data
unique_dates <- unique(ta_time$date)

#transform continuous deltas to categorical variables
#ta_time$delta <- factor(ta_time$delta)

#create new column with categorical variables <5, <10, >15 , over 15
ta_time$delta_bin <- cut(
  ta_time$delta,
  breaks = c(-Inf, 5, 10, 15, Inf),
  labels = c("<5", "<10", "<15", ">15"),
  right = FALSE
)

t_colors <- c("<5" = "gray", "<10" = "hotpink", "<15"="blue", ">15"="purple")

#filter by treatment
tr_amb <- ta_time[ta_time$treat == "amb",]
tr_ele <- ta_time[ta_time$treat =="elev",]
tr_hi <- ta_time[ta_time$treat =="hi",]
tr_xhi <- ta_time[ta_time$treat =="xhi",]

```
### AmbientTreat_time
```{r, fig.cap="Ambient treatment over time using all bottle sample data"}


treat_stab_amb <- ggplot(tr_amb, aes(x = date, y = calc_avg_ta, color = delta_bin, shape = precip)) +
  geom_point() +
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y") +
  ylab(expression(TA ~ (mu ~ mol))) +  
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_color_manual(values = t_colors)



treat_stab_amb
```

### ElevatedTreat_time
```{r}
treat_stab_ele <- ggplot(tr_ele, aes(x = date, y = calc_avg_ta, color = delta_bin, shape = precip)) +
  geom_point() +
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y") +
  ylab(expression(TA ~ (mu ~ mol))) +  
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_color_manual(values = t_colors)


treat_stab_ele
```

### HighTreat_time
```{r}
treat_stab_hi <- ggplot(tr_hi, aes(x = date, y = calc_avg_ta, color = delta_bin, shape = precip)) +
  geom_point() +
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y") +
  ylab(expression(TA ~ (mu ~ mol))) +  
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_color_manual(values = t_colors)


treat_stab_hi
```

### XhiTreat_time
```{r}
treat_stab_xhi <- ggplot(tr_xhi, aes(x = date, y = calc_avg_ta, color = delta_bin, shape = precip)) +
  geom_point() +
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y") +
  ylab(expression(TA ~ (mu ~ mol))) +  
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_color_manual(values = t_colors)


treat_stab_xhi
```


### TA_Time (precipitation excluded, >5umol delta excluded)

Total samples collected over course of the experiment excluding those with precipitation and any with delta >5 umol> Left with 399 samples. Down from 550, eliminated 151 samples. 

Break down of remaining samples:  

ambient	128  

elevated	114  

hi	87  

xhi	67  


Updated plots below. Can see that in the hi and extra high treamtents, gets as low as four samples per time point towards the end of the experiment (down from 12 per tiempoint per treatment). 

```{r}
d_filt <- ta_time[ta_time$delta <= 5 & ta_time$precip != "yes",]

p <- ggplot(d_filt, aes(x = date, y = calc_avg_ta, color = treat)) +
  geom_point() +
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y") +
  ylab(expression(TA ~ (mu ~ mol))) +  
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p

d_amb <-  ta_time[ta_time$delta <= 5 & ta_time$precip != "yes" & ta_time$treat == "amb",]
p_amb <- ggplot(d_amb, aes(x = date, y = calc_avg_ta)) +
  geom_point() +
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y") +
  ylab(expression(TA ~ (mu ~ mol))) +  
  theme_classic()+
  ggtitle("'Ambient' treatment over time") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p_amb

d_ele <- ta_time[ta_time$delta <= 5 & ta_time$precip != "yes" & ta_time$treat == "elev",]
p_ele <- ggplot(d_ele, aes(x = date, y = calc_avg_ta)) +
  geom_point() +
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y") +
  ylab(expression(TA ~ (mu ~ mol))) +  
  theme_classic()+
  ggtitle("'Elevated' treatment over time") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_ele

d_hi <- ta_time[ta_time$delta <= 5 & ta_time$precip != "yes" & ta_time$treat == "hi",]
p_hi <- ggplot(d_hi, aes(x = date, y = calc_avg_ta)) +
  geom_point() +
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y") +
  ylab(expression(TA ~ (mu ~ mol))) +  
  theme_classic()+
  ggtitle(" 'high' treatment over time") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_hi

d_xhi <- ta_time[ta_time$delta <= 5 & ta_time$precip != "yes" & ta_time$treat == "xhi",]
p_xhi <- ggplot(d_xhi, aes(x = date, y = calc_avg_ta)) +
  geom_point() +
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y") +
  ylab(expression(TA ~ (mu ~ mol))) + 
  ggtitle("'Extra high' treatment over time") +
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_xhi

```


# QC Growth rates
Took timepoint 0 on Feb 3rd. Corals were placed in vessels and ramped up to treatment levels for four days. Were at full treatment dosage on Feb 7. Noticed the lights were not set to the same parameters on Feb 15th. Corrected and took new datapoint on Feb 19th (T1). Took another point on March 8th (T2) and endpoint on March 23rd (T3). 

## Growth rates over time  

```{r}
bwrates <- read.csv('data2/bw_rates.csv', stringsAsFactors = TRUE)

lerates <- read.csv('data2/le_rates_edit.csv', stringsAsFactors = TRUE)

```

### Total calcification growth rates across timepoints  

```{r, fig.cap="total calcificaiton growth rates across timepoints"}
# Convert the data from wide format to long format
bw_long <- bwrates %>%
  pivot_longer(cols = starts_with("gr_"), 
               names_to = "timepoint", 
               values_to = "growth_rate")  %>%
  filter(timepoint != "gr_t0t3" & timepoint != "gr_t1t3")

# Rename the column from 'treatment' to 'dose'
#if ("treatment" %in% colnames(bwrates)) {
 # bwrates <- bwrates %>%
  #  rename(dose = treatment)
#}

dose_names <- c("AMB" = "ambient", "ELEV" = "+0.22", "HI" = "+0.44", "XHI" = "+0.66")

# Create the boxplot
bw_boxrateALL <- ggplot(bw_long, aes(x = timepoint, y = growth_rate, fill = treatment)) +
  geom_boxplot() +
  labs(x = "Timepoints", fill = "dose (mL) ") +
   ylab(expression(Growth~rate~(mg~cm^2^-1~day^-1))) +
  theme_minimal() +
    scale_fill_brewer(palette = "Set3", labels = dose_names)
  
bw_boxrateALL
```


```{r, fig.cap= "Using initial timepoint zero to end (left) vs. using second timepoint zero to end (right)"}

bwshort <- bwrates %>%
   pivot_longer(cols = starts_with("gr_"), 
               names_to = "timepoint", 
               values_to = "growth_rate")  %>%
  filter(timepoint != "gr_t0t1" & timepoint != "gr_t1t2" & timepoint != "gr_t2t3")

bw_boxrate <- ggplot(bwshort, aes(x = timepoint, y = growth_rate, fill = treatment)) +
  geom_boxplot() +
  labs(x = "Timepoints", fill = "dose (mL) ") +
   ylab(expression(Growth~rate~(mg~cm^2^-1~day^-1))) +
  theme_minimal() +
    scale_fill_brewer(palette = "Set3", labels = dose_names)

bw_boxrate
  
```
### Linear extension
#### Standards  
```{r, fig.cap="Measured a standard in three photos from each timepoint to check precision/accuracy of imageJ method across timepoints"}

tporder <- c("zero", "one", "two", "three")
le_st <- read.csv('data2/le_stand.csv', stringsAsFactors = TRUE)
le_stands <- ggplot(le_st, aes(x=factor(tp, level = tporder), y=length))+
  geom_boxplot() +
  geom_jitter()+
  labs(x= "timepoints", y="length (mm)")+
   ylim(22.5, 25)

le_stands
```
Across all timepoints, the ImageJ method has a standard deviation of ± 0.39 mm  and a standard error of ± 0.11 mm. 



Timepoint two's standard is measuring nearly 0.75 mm shorter than timepoints zero and one. Can I apply an offset or something to correct for it?  


#### Linear extension growth rates across timepoints  
You'll notice a a few negative rates from t2 to t3. The -0.4 mm/day rate comes from a coral that died three days after timepoint and it had a -1.47 mm difference in total length between tp2 and 3. I am going to maybe re-analyze the photos from timepoint 2. 

```{r, fig.cap="linear extension growth rates across all timepoints. Going to investigate the super negative rates."}
le_long <- lerates %>%
  pivot_longer(cols = starts_with("gr_"), 
               names_to = "timepoint", 
               values_to = "growth_rate")  %>%
  filter(timepoint != "gr_t0t3" & timepoint != "gr_t1t3")

# Rename the column from 'treatment' to 'dose'
#if ("treatment" %in% colnames(lerates)) {
 # lerates <- lerates %>%
  #  rename(dose = treatment)
#}

# Create the boxplot
le_boxrateALL <- ggplot(le_long, aes(x = timepoint, y = growth_rate, fill = treatment)) +
  geom_boxplot() +
  labs(x = "Timepoints", fill = "dose (mL) ") +
   ylab(expression(Growth~rate~(mm~day^-1)))+
  theme_minimal() +
    scale_fill_brewer(palette = "Set3", labels = dose_names)
  
le_boxrateALL
```

```{r, fig.cap="Using initial timepoint zero - end (left) vs. using second timeppoint zero to end (right)"}
leshort <- lerates %>%
   pivot_longer(cols = starts_with("gr_"), 
               names_to = "timepoint", 
               values_to = "growth_rate")  %>%
  filter(timepoint != "gr_t0t1" & timepoint != "gr_t1t2" & timepoint != "gr_t2t3")

le_boxrate <- ggplot(leshort, aes(x = timepoint, y = growth_rate, fill = treatment)) +
  geom_boxplot() +
  labs(x = "Timepoints", fill = "dose (mL) ") +
   ylab(expression(Growth~rate~(mm~day^-1))) +
  theme_minimal() +
    scale_fill_brewer(palette = "Set3", labels = dose_names)

le_boxrate
```
### Linear extension with offset correction
Growth results with linear extension offset applied to each timepoint. Took the mean standard length of timepoint 1 and (24.1 mm) and calculated offset for each timepoint that would bring the mean to 24.1 mm.  

t0 = offset of +0.02 mm  
t1 = no offset  
t2 = offset of + 0.873 mm  
t3 = offset of + 0.383 mm  

Comparing growth rates withdout and with the offset applied (gr_t0t1 vs grt0t1e) "e" standing for edited.  


```{r}
leratese <-  read.csv('data2/le_rates_edit.csv', stringsAsFactors = TRUE)

le_longe <- leratese %>%
  pivot_longer(cols = starts_with("gr_"), 
               names_to = "timepoint", 
               values_to = "growth_rate")  %>%
  filter(timepoint != "gr_t0t3" & timepoint != "gr_t1t3" & timepoint != "gr_t0t3e" & timepoint != "gr_t1t3e",)

le_boxrateALLe <- ggplot(le_longe, aes(x = timepoint, y = growth_rate, fill = treatment)) +
  geom_boxplot() +
  labs(x = "Timepoints", fill = "dose (mL) ") +
   ylab(expression(Growth~rate~(mm~day^-1)))+
  theme_minimal() +
    scale_fill_brewer(palette = "Set3", labels = dose_names)
  
le_boxrateALLe

leshorte <- leratese %>%
   pivot_longer(cols = starts_with("gr_"), 
               names_to = "timepoint", 
               values_to = "growth_rate")  %>%
  filter(timepoint != "gr_t0t1" & timepoint != "gr_t0t1e" & timepoint != "gr_t1t2" & timepoint != "gr_t1t2e" & timepoint != "gr_t2t3" &timepoint != "gr_t2t3e")

le_boxratee <- ggplot(leshorte, aes(x = timepoint, y = growth_rate, fill = treatment)) +
  geom_boxplot() +
  labs(x = "Timepoints", fill = "dose (mL) ") +
   ylab(expression(Growth~rate~(mm~day^-1))) +
  theme_minimal() +
    scale_fill_brewer(palette = "Set3", labels = dose_names)

le_boxratee

```


# Results  


```{r, results = "hide"}
#import bottle data
bottle_d <- read.csv('data2/BottleData.csv', stringsAsFactors = TRUE)

#Calculate the average "Avg.TA" and standard deviation and standard error for each coral across all dates
stats_per_coral <- bottle_d %>%
  group_by(Coral) %>%
  summarise(
    Average_TA = mean(Avg.TA, na.rm = TRUE),
    SD_TA = sd(Avg.TA, na.rm = TRUE),
    SE_TA = sd(Avg.TA, na.rm = TRUE) / sqrt(n())
  )
print(stats_per_coral)

#imported this data to google sheets and made growth_data csv with average TA for each coral and growth rates from bw and le data
```

```{r}
grdata <- read.csv('data2/growth_data.csv', stringsAsFactors = TRUE)

grdata$avg_ta_mmol<-grdata$avg_ta/1000
grdata$ta_sd_mmol<-grdata$ta_sd/1000
grdata$ta_se_mmol<-grdata$ta_se/1000
# Create new variable. I converted umol to mmol since the slopes were 0.00 something when the [ta] were in the order of thousands 
```

Data analysis using bottle data excluding deltas > or equal to 5 umol and any with precipitation.  

##  Carb chem parameters    
Carb chem parameters generated using seacarb with measured DIC and TA values. Includes samples from 2/3 - 3/23. 

```{r}

#sort data by treatment, include blanks
amb_d <- bottle_d[bottle_d$Treatment == "AMB" & !is.na(bottle_d$DIC),]
  
seacarb.output.amb = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = amb_d$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = amb_d$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = amb_d$Salinity,
 
  #temperature, in deg C
  T = amb_d$temp,
 
  #pressure, need to convert from dbar to bar
  P = amb_d$dbar/ 10
)

#Elevated treatment
elev_d <- bottle_d[bottle_d$Treatment == "ELEV" & !is.na(bottle_d$DIC),]
  
seacarb.output.elev = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = elev_d$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = elev_d$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = elev_d$Salinity,
 
  #temperature, in deg C
  T = elev_d$temp,
 
  #pressure, need to convert from dbar to bar
  P = elev_d$dbar/ 10
)

#High Treatment
hi_d <- bottle_d[bottle_d$Treatment == "HI" & !is.na(bottle_d$DIC),]
  
seacarb.output.hi = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = hi_d$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = hi_d$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = hi_d$Salinity,
 
  #temperature, in deg C
  T = hi_d$temp,
 
  #pressure, need to convert from dbar to bar
  P = hi_d$dbar/ 10
)

#Extra high treatment
xhi_d <- bottle_d[bottle_d$Treatment == "XHI" & !is.na(bottle_d$DIC),]
  
seacarb.output.xhi = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = xhi_d$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = xhi_d$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = xhi_d$Salinity,
 
  #temperature, in deg C
  T = xhi_d$temp,
 
  #pressure, need to convert from dbar to bar
  P = xhi_d$dbar/ 10
)

```

### ANOVA_treatments  

Was alkalinity statistically different between treatments?   

```{r}

treat_aov <- aov(avg_ta_mmol ~ treatment, data = grdata)

summary(treat_aov)

tukey_treat <- TukeyHSD(treat_aov)
print(tukey_treat)

```
All treatments statistically different from eachother (p < 0.000) except for the extra high and high treatments (p = 0.68)  

### Stability of treatment over time
#### TA by treatment barplot and boxplot  

```{r}
#ta_time <- read.csv('data/ta_time.csv', stringsAsFactors = TRUE)

dose_names <- c("AMB" = "ambient", "ELEV" = "+0.22", "HI" = "+0.44", "XHI" = "+0.66")
ta_summary <- bottle_d %>%
  group_by(Treatment) %>%
  summarise(
    mean_ta = mean(Avg.TA),
    sem_ta = sd(Avg.TA) / sqrt(n())
  )
print(ta_summary)

bar_ta <- ggplot(ta_summary, aes(x = Treatment, y = mean_ta)) +
  geom_bar(stat = "identity", position = position_dodge(), width = 0.7) +
  geom_errorbar(aes(ymin = mean_ta - sem_ta, ymax = mean_ta + sem_ta),width = 0.2,position = position_dodge(0.7)) +
  theme_classic()

bar_ta

#boxplot 

box_ta <- ggplot(bottle_d, aes(x = Treatment, y = Avg.TA)) +
  geom_boxplot() +
  ylab("Total Alkalinity (umol)")+
  scale_x_discrete(labels = c("ambient", "+0.22 mL", "+0.44 mL", "+0.66 mL"))+
  theme_classic()

box_ta

```
#### Treatment stability over time  

```{r}
# Summarize the data to create mean and std dev for each day by treatment
#convert date column to "Date" type.
bottle_d$Date <- as.Date(bottle_d$Date, format = "%m/%d/%Y")

# Get the unique dates from the data
unique_dates <- unique(bottle_d$Date)
summary_data <- bottle_d %>%
  group_by(Date, Treatment) %>%
  summarise(
    mean_ta = mean(Avg.TA),
    se_ta = sd(Avg.TA) / sqrt(n())
  ) %>%
  ungroup()

# Plot the summarized data
treat_stab2 <- ggplot(summary_data, aes(x = Date, y = mean_ta, colour = Treatment)) +
  geom_point(size = 3.5) +
  geom_linerange(aes(ymin = mean_ta - se_ta, ymax = mean_ta + se_ta)) +
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y") +
  ylab(expression(TA ~ (mu ~ mol))) +
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_colour_discrete(labels = dose_names)


treat_stab2
```

#### TreatStability_Time_AllDataPoints  


```{r}

# Plot the summarized data
treat_stab <- ggplot(bottle_d, aes(x = Date, y = Avg.TA, colour = Treatment)) +
  geom_point(size = 2) +
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y") +
  ylab(expression(TA ~ (mu ~ mol))) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_colour_discrete(labels = dose_names)


treat_stab
```


### Blanks  

Total alkalinity in blanks by treatment

  
```{r}

#convert beaker to categorical var
bottle_d$Beaker <- as.factor(bottle_d$Beaker)

bottle_d$Date <- as.Date(bottle_d$Date, format = "%m/%d/%Y")  #Adjust the format according to your actual date format

# Get the unique dates from the data
unique_dates <- unique(bottle_d$Date)

blanks_amb <- ggplot(subset(bottle_d, Beaker %in% c("13", "44")), aes(Date, Avg.TA, color = Beaker)) +
  geom_point() +
  labs(title = "ambient blanks")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y")

blanks_elev <- ggplot(subset(bottle_d, Beaker %in% c("3", "33")), aes(Date, Avg.TA, color = Beaker)) +
  geom_point()+
  labs(title = "elevated treatment blanks (+0.22 mL)")+
  theme_classic()+
   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y")

blanks_hi <- ggplot(subset(bottle_d, Beaker %in% c("22", "27")), aes(Date, Avg.TA, color = Beaker)) +
  geom_point()+
  labs(title = "hi treatment blanks (+0.44 mL)")+
  theme_classic()+
   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y")

blanks_xhi <- ggplot(subset(bottle_d, Beaker %in% c("11", "40")), aes(Date, Avg.TA, color = Beaker)) +
  geom_point()+
  labs(title = "extra high traetment blanks (+0.66 mL)")+
  theme_classic()+
   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_date(breaks = unique_dates, date_labels = "%m/%d/%Y")


blanks_amb
blanks_elev
blanks_hi
blanks_xhi

```


## TotalCalcification_Alkalinity  

### Linear mixed effect models  
#### T0 -> T3 (before lights fixed)
to check for random effects (tank, genotype)
BW from t0 to t3, growth ~ ta, 1|geno, 1|tank
```{r}
#BW mixed effect linear model 1
LM_BWTA1 <- lmerTest::lmer(gr_t0t3 ~ avg_ta_mmol + (1|geno) + (1|tank), data = grdata)
summary(LM_BWTA1)
anova(LM_BWTA1)
ranova(LM_BWTA1)
step(LM_BWTA1)
plot(LM_BWTA1)

```

Appears there is a tank effect on bw growth when using t0 to t3 growth points... Makes sense because of my lights!  

#### T1 -> T3 (after lights fixed)
```{r}
#BW mixed effect linear model 2
LM_BWTA2 <- lmerTest::lmer(gr_t1t3 ~ avg_ta_mmol + (1|geno) + (1|tank), data = grdata)
summary(LM_BWTA2)
anova(LM_BWTA2)
ranova(LM_BWTA2)
step(LM_BWTA2)
plot(LM_BWTA2)
```

Using the timepoint after the lights were fixed eliminates the tank effect.  

Simplest linear model: 
```{r}
LM_BWTA2a <- lm(gr_t1t3 ~ avg_ta_mmol, data = grdata)
summary(LM_BWTA2a)
anova(LM_BWTA2a)
plot(LM_BWTA2a)

slope <- coef(LM_BWTA2a)["avg_ta_mmol"]
summary_model <- summary(LM_BWTA2a)
r_squared <- summary_model$r.squared

#r_squared
#slope
```

Total alkalinity does have an effect on total calcification (p < 0.001)  
R-squared: 0.439  

slope: 0.2077  



### Plots  
#### TA_total calcification (Linear regression, T0-T3)

```{r,fig.cap="Effect of total alkalinity on calcification (standardized to initial surface area) from Feb 3rd to Mar23rd. (p < 0.000" }
#define custom labels for genotype
labels_genotype <- c("C" = "Coopers",
                     "M" = "Marker 9",
                     "S" = "Sunny Isles")

bwt0t3 <- ggplot(data = grdata, aes(x = avg_ta, y = gr_t0t3, colour = geno)) +
  geom_point(aes(shape = treatment)) +
  geom_smooth(color = 1, method = 'lm', se = TRUE, linetype = "dashed") +
  scale_colour_discrete(labels = labels_genotype) +
  scale_shape_discrete(labels = dose_names) +  # Applying dose_names to treatment legend
  xlab(expression(TA~(mu~mol))) + 
  ylab(expression(Growth~rate~(mg~cm^2 ^-1~day^-1))) + 
  labs(colour = "Genotype", shape = "dose (mL)") +  # Changing the title of the treatment legend
  theme_classic()
   

bwt0t3

```


```{r, fig.cap="total calcification growth rates by treatment from t0 to t3"}
bwt0t3bar <- ggplot(data = grdata, aes(x=treatment, y=gr_t0t3))+
  geom_boxplot()+
  theme_classic() +
  labs(x = "Treatment") +
  ylab(expression(Growth~rate~(mg~cm^2^-1~day^-1)))


bwt0t3bar
  
```

#### TA_total calcification (Linear regression, T1-T3)
```{r, fig.cap="Effect of total alkalinity on calcification (standardized to initial surface area) from Feb 19th to Mar 23rd. p < 0.000" }
bwt1t3 <- ggplot(data = grdata, aes(x = avg_ta, y = gr_t1t3, colour = treatment)) +
  geom_point(aes(shape = geno)) +
  geom_smooth(color = 1, method = 'lm', se = TRUE, linetype = "dashed") +
  scale_colour_discrete(labels = labels_genotype) +
  scale_shape_discrete(labels = dose_names) +  # Applying dose_names to treatment legend
  xlab(expression(TA~(mu~mol))) + 
  ylab(expression(Growth~rate~(mg~cm^2 ^-1~day^-1))) + 
  labs(colour = "Genotype", shape = "dose (mL)") +  # Changing the title of the treatment legend
  theme_classic()
bwt1t3
```


```{r, fig.cap="total calcification growth rates by treatment from t1 to t3"}
bwt1t3bar <- ggplot(data = grdata, aes(x=treatment, y=gr_t1t3))+
  geom_boxplot()+
  theme_classic() +
  labs(x = "Treatment") +
  ylab(expression(Growth~rate~(mg~cm^2^-1~day^-1)))


bwt1t3bar
```

## LinearExtension_Alkalinity  

### Linear mixed effect models  

#### T0 -> T3  

Mixed effect model to check for genotype and tank effects on linear extension (used linear extension growth rates with the offsets)  

```{r,}
#LE mixed effect linear model t0-t3
LM_LETA <- lmerTest::lmer(le_t0t3e ~ avg_ta_mmol + (1|geno) + (1|tank), data = grdata)
summary(LM_LETA)
anova(LM_LETA)
ranova(LM_LETA)
step(LM_LETA)
plot(LM_LETA)
```

no tank of genotype effect, but also no significant effect of TA on linear extension. 

#### T1 -> T3  '
```{r}
#LE mixed effect linear model t1-t3
LM_LETA2 <- lmerTest::lmer(le_t1t3e ~ avg_ta_mmol + (1|geno) + (1|tank), data = grdata)
summary(LM_LETA2)
anova(LM_LETA2)
ranova(LM_LETA2)
step(LM_LETA2)
plot(LM_LETA2)
```

Hooray! Signficiant effect of TA on linear extension with no tank or genotype effects !!!!  

 


```{r}
LM_LETA2a <- lm(le_t1t3e ~ avg_ta_mmol, data = grdata)
summary(LM_LETA2a)
anova(LM_LETA2a)
plot(LM_LETA2a)

slopeLE <- coef(LM_LETA2a)["avg_ta_mmol"]
summary_model <- summary(LM_LETA2a)
r_squaredLE <- summary_model$r.squared

r_squaredLE
slopeLE
```

Simplest linear model produces p = 0.038  
r-squared: 0.11  
slope: 0.016  

### Plots  

#### TA_LinearExtension (T0-T3)  


```{r, fig.cap="Effect of TA on linear extension from Feb 3rd to Mar 23rd. No statistically significant effect (p = 0.095)"}
#LE scatter plot w linear regression t0-t3
let0t3 <- ggplot(data = grdata, aes(x = avg_ta, y = le_t0t3e, colour = geno)) +
  geom_point(aes(shape = treatment)) +
  geom_smooth(color = 1, method = 'lm', se = TRUE, linetype = "dashed") +
  scale_colour_discrete(labels = labels_genotype) +
  scale_shape_discrete(labels = dose_names) +  # Applying dose_names to treatment legend
  xlab(expression(TA~(mu~mol))) + 
  ylab(expression(Growth~rate~(mm~day^-1))) + 
  labs(colour = "Genotype", shape = "dose (mL)") +  # Changing the title of the treatment legend
  theme_classic()

let0t3
   


```


```{r, fig.cap="linear extension growth rates by treatment from t0 to t3"}
let0t3bar <- ggplot(data = grdata, aes(x=treatment, y=le_t0t3e))+
  geom_boxplot()+
  theme_classic() +
  labs(x = "Treatment") +
  ylab(expression(Growth~rate~(mm~day^-1)))


let0t3bar
```

#### TA_LinearExtension (T1-T3)  

```{r, fig.cap="Effect of TA on linear extension from Feb 19th to Mar 23rd. Significant effect (P = 0.038)"}
#LE scatter plot w linear regression t0-t3
let1t3 <- ggplot(data = grdata, aes(x = avg_ta, y = le_t1t3e, colour = treatment)) +
  geom_point(aes(shape = geno)) +
  geom_smooth(color = 1, method = 'lm', se = TRUE, linetype = "dashed") +
  scale_colour_discrete(labels = labels_genotype) +
  scale_shape_discrete(labels = dose_names) +  # Applying dose_names to treatment legend
  xlab(expression(TA~(mu~mol))) + 
  ylab(expression(Growth~rate~(mm~day^-1))) + 
  labs(colour = "Genotype", shape = "dose (mL)") +  # Changing the title of the treatment legend
  theme_classic()

let1t3
   

```

#### Total_LE_Growth(mm)_TA  
```{r}
total_le <- read.csv('data2/TotalLE.csv', stringsAsFactors = TRUE)

leTOTAL <- ggplot(data = total_le, aes(x = avg_ta, y = t1t3, colour = treatment)) +
  geom_point(aes(shape = geno)) +
  geom_smooth(color = 1, method = 'lm', se = TRUE, linetype = "dashed") +
  scale_colour_discrete(labels = labels_genotype) +
  scale_shape_discrete(labels = dose_names) +  # Applying dose_names to treatment legend
  xlab(expression(TA~(mu~mol))) + 
  ylab("Total growth (mm)") + 
  labs(colour = "Genotype", shape = "dose (mL)") +  # Changing the title of the treatment legend
  theme_classic()

leTOTAL
   


```


```{r, fig.cap="linear extension growth rates by treatment from t1 to t3"}
let1t3bar <- ggplot(data = grdata, aes(x=treatment, y=le_t1t3e))+
  geom_boxplot()+
  theme_classic() +
  labs(x = "Treatment") +
  ylab(expression(Growth~rate~(mm~day^-1)))


let1t3bar
```

linear extension-- total growth vs TA. 

## Final Figures
### Buoyant weight 
```{r}
#color pallette to assign treatments 
treatment_colors <- c(
  AMB = "#00BFFF",   # Light blue
  ELEV = "#3CB371",  # You can adjust this color
  HI = "#9370DB",    # You can adjust this color
  XHI = "#FF7F50"  )  # Coral

# Combine data for faceting
bwlong <- grdata %>%
  pivot_longer(cols = starts_with("gr_"), 
               names_to = "timepoint", 
               values_to = "growth_rate") %>%
  mutate(panel = case_when(
    timepoint %in% c("gr_t1t2", "gr_t2t3") ~ "Panel 1",
    timepoint == "gr_t1t3" ~ "Panel 2"
  )) %>%
  filter(!is.na(panel))  # Exclude rows where panel is NA

y_limits <- range(c(bwlong$growth_rate, grdata$gr_t1t3))

# Create the boxplot with custom panels
bw_box <- ggplot(bwlong, aes(x = timepoint, y = growth_rate, fill = treatment)) +
  geom_boxplot() +
  labs(x = "Timepoints", fill = "Dose (mL)") +
  ylab(expression(Growth~rate~(mg~cm^2^-1~day^-1))) +
   scale_fill_manual(values = treatment_colors, labels = dose_names) +
  facet_wrap(~panel, scales = "free_x", labeller = as_labeller(c("Panel 1" = "Growth rates over time", "Panel 2" = "Overall growth rates"))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_classic() +
  ylim(y_limits) +
  theme(legend.position = "bottom")+
   stat_compare_means(aes(group = treatment), 
                     method = "anova", 
                     label = "p.signif", 
                     hide.ns = TRUE, 
                     comparisons = list(c("AMB", "ELEV"), c("AMB", "HI"), c("AMB", "XHI"), c("ELEV", "HI"), c("ELEV", "XHI"), c("HI", "XHI")))
  

bw_box

# Create scatter plot 
bw_scat <- ggplot(data = grdata, aes(x = avg_ta, y = gr_t1t3, colour = treatment)) +
  geom_point(aes(shape = geno)) +
  geom_smooth(color = 1, method = 'lm', se = TRUE, linetype = "dashed") +
   scale_colour_manual(values = treatment_colors, labels = dose_names ) +  # Use scale_colour_manual to apply treatment_colors
  scale_shape_discrete(labels = labels_genotype) +  # Apply labels to the genotype legend
  xlab(expression(TA~(mu~mol))) + 
  ylab(expression(Growth~rate~(mg~cm^2 ^-1~day^-1))) + 
  labs(colour = "dose (mL)", shape = "genotype") +  # Changing the title of the treatment legend
  theme_classic() +
  ylim(y_limits)

bw_scat

```

### Linear Extension  
```{r}
# Convert the data from wide format to long format
lelong <- grdata %>%
  pivot_longer(cols = starts_with("le_"), 
               names_to = "timepoint", 
               values_to = "growth_rate") %>%
   mutate(panel = case_when(
    timepoint %in% c("le_t1t2e", "le_t2t3e") ~ "Panel 1",
    timepoint == "le_t1t3e" ~ "Panel 2"
  )) %>%
  filter(!is.na(panel))  # Exclude rows where panel is NA

# Determine the y-axis limits
y_limits <- range(c(lelong$growth_rate, grdata$le_t1t3e))

# Create the boxplot for growth rates across timepoints
le_box <- ggplot(lelong, aes(x = timepoint, y = growth_rate, fill = treatment)) +
  geom_boxplot() +
  labs(x = "Timepoints", fill = "dose (mL) ") +
   ylab(expression(Growth~rate~(mm~day^-1))) +
  theme_classic() +
     scale_fill_manual(values = treatment_colors, labels = dose_names) +
  theme(legend.position = "bottom")+
  facet_wrap(~panel, scales = "free_x", labeller = as_labeller(c("Panel 1" = "Growth rates over time", "Panel 2" = "Growth from T1 to T3"))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_classic() +
  ylim(y_limits) +
  theme(legend.position = "bottom")+
   stat_compare_means(aes(group = treatment), 
                     method = "anova", 
                     label = "p.signif", 
                     hide.ns = TRUE, 
                     comparisons = list(c("AMB", "ELEV"), c("AMB", "HI"), c("AMB", "XHI"), c("ELEV", "HI"), c("ELEV", "XHI"), c("HI", "XHI")))
  
le_box

# Create scatter plot 
le_scat <- ggplot(data = grdata, aes(x = avg_ta, y = le_t1t3e, colour = treatment)) +
  geom_point(aes(shape = geno)) +
  geom_smooth(color = 1, method = 'lm', se = TRUE, linetype = "dashed") +
  scale_colour_manual(values = treatment_colors, labels = dose_names) +  # Use scale_colour_manual to apply treatment_colors
  scale_shape_discrete(labels = labels_genotype) +  # Apply labels to the genotype legend
  xlab(expression(TA~(mu~mol))) + 
  ylab(expression(Growth~rate~(mm~day^-1))) + 
  labs(colour = "dose (mL)", shape = "genotype") +  # Changing the title of the treatment legend
  theme_classic() 

le_scat

```


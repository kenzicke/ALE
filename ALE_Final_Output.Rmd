---
title: "ALE_final_output"
author: "Kenzie Cooke"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#include = FALSE omits code chunks and results from showing up in html

#knitr::opts_chunk$set to set global opts that apply to all chunks
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

#echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures.

#message = FALSE prevents messages that are generated by code from appearing in the finished file.

#warning = FALSE prevents warnings that are generated by code from appearing in the finished.

#fig.cap = "..." adds a caption to graphical results

```

```{r libraries}

library(ggplot2)
library(dplyr)
library(nlstools)
library(seacarb)
library(emmeans)
library(broom)
library(lmerTest)
library(tidyr)
library(patchwork)
library(ggsignif)
library(ggpubr)
```


##Bottle Sample filtering  
### Import/filter data
```{r}


# Read the original raw data
forseacarb_raw <- read.csv('data2/bottle_raw.csv', stringsAsFactors = TRUE)


# Filter out samples where delta > 5, precip == "yes", and missing DIC
forseacarb_filtered <- forseacarb_raw %>%
  filter(!delta >= 5) %>%
  filter(!precip == "yes") %>%
  filter(!is.na(DIC) & DIC != "")

# Run seacarb to compute carbonate chemistry
seacarb.output.all = carb(
  flag = 15,
  var1 = forseacarb_filtered$Avg.TA / 10^6,  # Convert TA from umol/kg to mol/kg
  var2 = forseacarb_filtered$DIC / 10^6,  # Convert DIC from umol/kg to mol/kg
  S = forseacarb_filtered$Salinity,  # Salinity (psu)
  T = forseacarb_filtered$temp,  # Temperature (°C)
  P = forseacarb_filtered$dbar / 10  # Pressure (bar)
)

# Add pCO2 results to the filtered dataframe
forseacarb_filtered <- forseacarb_filtered %>%
  mutate(
    pCO2 = seacarb.output.all$pCO2,
    pco1000 = ifelse(pCO2 > 1000, "yes", "no"),
    pco2000 = ifelse(pCO2 > 2000, "yes", "no"),
    pco5000 = ifelse(pCO2 > 5000, "yes", "no")
  )

# Extract only the columns needed for merging
pco2_data <- forseacarb_filtered %>%
  dplyr::select(sample_id, pCO2, pco1000, pco2000, pco5000)

# Merge pCO2 columns back into the original dataset (including missing dic rows)
bottle_all <- forseacarb_raw %>%
  filter(!delta >= 5)%>%
  filter(!precip == "yes")%>%
  left_join(pco2_data, by = "sample_id")


```

### Filtered chem datasets
```{r}
bottle_1000 <- bottle_all %>%
  filter(pco1000 != 'yes' | is.na(pco1000))

bottle_2000 <- bottle_all %>%
  filter(pco2000 != 'yes' | is.na(pco2000))

bottle_5000 <- bottle_all %>%
  filter(pco5000 != 'yes' | is.na(pco5000))

bottle_feb7 <- bottle_all %>%
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%  # Ensure proper conversion
  filter(Date >= as.Date("2024-02-07"))%>%
  filter(pco1000 != "yes"| is.na(pco1000))


```
### Coral TA stats
Generate mean, sd, sem TA for each coral 
```{r, results = "hide"}


#Calculate the average ta and standard deviation and standard error for each coral across all dates
ta_coral_all <- bottle_all %>%
  group_by(Coral) %>%
  summarise(
     n = sum(!is.na(Avg.TA)),  # Count of non-NA values
    avg_ta = mean(Avg.TA, na.rm = TRUE),
    ta_sd = sd(Avg.TA, na.rm = TRUE),
    ta_se = sd(Avg.TA, na.rm = TRUE) / sqrt(n())
  )

#filtering out pco2 >1000
ta_coral_1000 <- bottle_1000 %>%
  group_by(Coral) %>%
  summarise(
     n = sum(!is.na(Avg.TA)),  # Count of non-NA values
    avg_ta = mean(Avg.TA, na.rm = TRUE),
    ta_sd = sd(Avg.TA, na.rm = TRUE),
    ta_se = sd(Avg.TA, na.rm = TRUE) / sqrt(n())
  )

ta_coral_2000 <- bottle_2000 %>%
  group_by(Coral) %>%
  summarise(
    n = sum(!is.na(Avg.TA)),  # Count of non-NA values
    avg_ta = mean(Avg.TA, na.rm = TRUE),
    ta_sd = sd(Avg.TA, na.rm = TRUE),
    ta_se = sd(Avg.TA, na.rm = TRUE) / sqrt(n())
  )

ta_coral_5000 <- bottle_5000 %>%
  group_by(Coral) %>%
  summarise(
    n = sum(!is.na(Avg.TA)),  # Count of non-NA values
    avg_ta = mean(Avg.TA, na.rm = TRUE),
    ta_sd = sd(Avg.TA, na.rm = TRUE),
    ta_se = sd(Avg.TA, na.rm = TRUE) / sqrt(n())
  )

ta_coral_feb7 <- bottle_feb7 %>%
  group_by(Coral) %>%
  summarise(
    n = sum(!is.na(Avg.TA)),  # Count of non-NA values
    avg_ta = mean(Avg.TA, na.rm = TRUE),
    ta_sd = sd(Avg.TA, na.rm = TRUE),
    ta_se = sd(Avg.TA, na.rm = TRUE) / sqrt(n())
  )

```
### Growth dataframes
Import ta stats from above filtered data sets into growth dataframes. Create four based on different filtering of chem data. 

```{r}

growth_raw <- read.csv('data2/growth_raw.csv', stringsAsFactors = TRUE)

# Merge TA statistics into growth data by coral
growth_all <- growth_raw %>%
  left_join(ta_coral_all, by = "Coral")

growth_all$avg_ta_mmol<-growth_all$avg_ta/1000
growth_all$ta_sd_mmol<-growth_all$ta_sd/1000
growth_all$ta_se_mmol<-growth_all$ta_se/1000
# Create new variable. I converted umol to mmol since the slopes were 0.00 something when the [ta] were in the order of thousands 

# pco1000
growth_1000 <- growth_raw %>%
  left_join(ta_coral_1000, by = "Coral")

growth_1000$avg_ta_mmol<-growth_1000$avg_ta/1000
growth_1000$ta_sd_mmol<-growth_1000$ta_sd/1000
growth_1000$ta_se_mmol<-growth_1000$ta_se/1000

#pco2000
growth_2000 <- growth_raw %>%
  left_join(ta_coral_2000, by = "Coral")

growth_2000$avg_ta_mmol<-growth_2000$avg_ta/1000
growth_2000$ta_sd_mmol<-growth_2000$ta_sd/1000
growth_2000$ta_se_mmol<-growth_2000$ta_se/1000

#pco5000
growth_5000 <- growth_raw %>%
  left_join(ta_coral_5000, by = "Coral")

growth_5000$avg_ta_mmol<-growth_5000$avg_ta/1000
growth_5000$ta_sd_mmol<-growth_5000$ta_sd/1000
growth_5000$ta_se_mmol<-growth_5000$ta_se/1000

#filter samples before feb 16
growth_feb7 <- growth_raw %>%
  left_join(ta_coral_feb7, by = "Coral")

growth_feb7$avg_ta_mmol<-growth_feb7$avg_ta/1000
growth_feb7$ta_sd_mmol<-growth_feb7$ta_sd/1000
growth_feb7$ta_se_mmol<-growth_feb7$ta_se/1000


```

### DECIDE CUTOFF for PCO2 values
Choose which data sets to use for all figures and tables. Carb chem data excludes bottle samples with deltas >5, with precipitaiton, and with Seacarb generated pco2 values greater than the cutoff chosen above.  
```{r}
bottle_d <- bottle_2000
grdata <- growth_2000
```


##  Seacarb output    
Carb chem parameters generated using seacarb with measured DIC and TA values.   

### Coral beakers
Generate seacarb parameters for beakers with corals by treatment

```{r}

#sort data by treatment, exclude blanks
amb_d <- bottle_d[bottle_d$Treatment == "AMB" & bottle_d$Coral != "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.amb = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = amb_d$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = amb_d$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = amb_d$Salinity,
 
  #temperature, in deg C
  T = amb_d$temp,
 
  #pressure, need to convert from dbar to bar
  P = amb_d$dbar/ 10
)

#Elevated treatment
elev_d <- bottle_d[bottle_d$Treatment == "ELEV" &  bottle_d$Coral != "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.elev = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = elev_d$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = elev_d$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = elev_d$Salinity,
 
  #temperature, in deg C
  T = elev_d$temp,
 
  #pressure, need to convert from dbar to bar
  P = elev_d$dbar/ 10
)

#High Treatment
hi_d <- bottle_d[bottle_d$Treatment == "HI" & bottle_d$Coral != "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.hi = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = hi_d$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = hi_d$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = hi_d$Salinity,
 
  #temperature, in deg C
  T = hi_d$temp,
 
  #pressure, need to convert from dbar to bar
  P = hi_d$dbar/ 10
)

#Extra high treatment
xhi_d <- bottle_d[bottle_d$Treatment == "XHI" & bottle_d$Coral != "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.xhi = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = xhi_d$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = xhi_d$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = xhi_d$Salinity,
 
  #temperature, in deg C
  T = xhi_d$temp,
 
  #pressure, need to convert from dbar to bar
  P = xhi_d$dbar/ 10
)

```

### Blank Beakers
Generate seacarb parameters for blank beakers by treatment
```{r}
#Now do seacarb parameters for Blanks 
#sort data by treatment 
amb_blank <- bottle_d[bottle_d$Treatment == "AMB" & bottle_d$Coral == "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.amb_blank = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = amb_blank$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = amb_blank$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = amb_blank$Salinity,
 
  #temperature, in deg C
  T = amb_blank$temp,
 
  #pressure, need to convert from dbar to bar
  P = amb_blank$dbar/ 10
)

#Elevated treatment
elev_blank <- bottle_d[bottle_d$Treatment == "ELEV" &  bottle_d$Coral == "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.elev.blank = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = elev_blank$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = elev_blank$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = elev_blank$Salinity,
 
  #temperature, in deg C
  T = elev_blank$temp,
 
  #pressure, need to convert from dbar to bar
  P = elev_blank$dbar/ 10
)

#High Treatment
hi_blank <- bottle_d[bottle_d$Treatment == "HI" & bottle_d$Coral == "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.hi.blank = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = hi_blank$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = hi_blank$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = hi_blank$Salinity,
 
  #temperature, in deg C
  T = hi_blank$temp,
 
  #pressure, need to convert from dbar to bar
  P = hi_blank$dbar/ 10
)

#Extra high treatment
xhi_blank <- bottle_d[bottle_d$Treatment == "XHI" & bottle_d$Coral == "Blank" & !is.na(bottle_d$DIC),]
  
seacarb.output.xhi.blank = carb(
  #flag refers to which two CO2 system variables are being used; here we are using ALK and DIC
  flag = 15,
 
  #need to convert TA from umol/kg to mol/kg
  var1 = xhi_blank$Avg.TA / 10 ^ 6,
 
  #need to convert DIC from umol/kg to mol/kg
  var2 = xhi_blank$DIC / 10 ^ 6,
 
  #salinity, in psu
  S = xhi_blank$Salinity,
 
  #temperature, in deg C
  T = xhi_blank$temp,
 
  #pressure, need to convert from dbar to bar
  P = xhi_blank$dbar/ 10
)
```
### Seacarb stats by treatment  
Create stats with  mean, sd, and SEM for all parameters grouped by treatment (corals and empty beakers separate)

```{r}
stats_amb <- seacarb.output.amb %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )
stats_amb_blank <- seacarb.output.amb_blank %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )


# elevated
stats_elev <- seacarb.output.elev %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )
stats_elev_blank <- seacarb.output.elev.blank %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )

#high
stats_hi <- seacarb.output.hi %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )
stats_hi_blank <- seacarb.output.hi.blank %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )


#xhi
stats_xhi <- seacarb.output.xhi %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )
stats_xhi_blank <- seacarb.output.xhi.blank %>%
  summarise(
    n = sum(!is.na(.[[1]])),  # Count non-NA values from any column
    across(everything(), list(
      mean = ~mean(.x, na.rm = TRUE),
      SEM = ~sd(.x, na.rm = TRUE) / sqrt(n)
    ), .names = "{.col}_{.fn}")
  )


```

### Create Seacarb Table
Export stats to carb chem table for manuscript

```{r}
# Load necessary libraries
library(dplyr)
library(tidyr)
library(writexl)

# Add a treatment and type column
stats_amb <- stats_amb %>% mutate(Treatment = "AMB", Type = "Regular")
stats_amb_blank <- stats_amb_blank %>% mutate(Treatment = "AMB", Type = "Blank")

stats_elev <- stats_elev %>% mutate(Treatment = "ELEV", Type = "Regular")
stats_elev_blank <- stats_elev_blank %>% mutate(Treatment = "ELEV", Type = "Blank")

stats_hi <- stats_hi %>% mutate(Treatment = "HI", Type = "Regular")
stats_hi_blank <- stats_hi_blank %>% mutate(Treatment = "HI", Type = "Blank")

stats_xhi <- stats_xhi %>% mutate(Treatment = "XHI", Type = "Regular")
stats_xhi_blank <- stats_xhi_blank %>% mutate(Treatment = "XHI", Type = "Blank")

# Combine all tables
combined_stats <- bind_rows(
  stats_amb, stats_amb_blank,
  stats_elev, stats_elev_blank,
  stats_hi, stats_hi_blank,
  stats_xhi, stats_xhi_blank
)

# Load necessary packages
library(dplyr)
library(tidyr)
library(writexl)
library(flextable)
library(officer)

# Define the variables to keep in the correct orde
vars_to_keep <- c(
  "n", 
  "ALK_mean", "ALK_SEM", 
  "DIC_mean", "DIC_SEM", 
  "pCO2_mean", "pCO2_SEM", 
  "pH_mean", "pH_SEM", 
  "OmegaAragonite_mean", "OmegaAragonite_SEM", 
  "HCO3_mean", "HCO3_SEM", 
  "CO3_mean", "CO3_SEM", 
  "S_mean", "S_SEM"
)

# Filter only the selected variables
stats_filtered <- combined_stats %>%
  pivot_longer(cols = -c(Treatment, Type), 
               names_to = c("Variable"),
               values_to = "Value") %>%
  filter(Variable %in% vars_to_keep)

# Reshape into wide format (treatment as columns, mean & SEM under each)
stats_wide <- stats_filtered %>%
  pivot_wider(names_from = Treatment, 
              values_from = Value,
              names_glue = "{Treatment}_{.value}")

# Ensure columns match the desired output format
col_order <- c("Variable", "Type", 
               "AMB", "AMB_SEM", 
               "ELEV", "ELEV_SEM", 
               "HI", "HI_SEM", 
               "XHI", "XHI_SEM")

# Rename columns for clarity
colnames(stats_wide) <- gsub("_mean", "", colnames(stats_wide))
colnames(stats_wide) <- gsub("_SEM", " SEM", colnames(stats_wide))

# Arrange the data in the correct order
stats_wide <- stats_wide %>%
  arrange(match(Variable, vars_to_keep))


print(stats_wide)

```

### ANOVA_treatments  

Was alkalinity statistically different between treatments?   

```{r}

#install.packages('multcomp')# install multcomp before!
#install.packages('multcompView')
library(multcomp)
library(multcompView)

treat_aov <- aov(avg_ta_mmol ~ treatment, data = grdata)
summary(treat_aov)

treat_aov_2 <- lm(avg_ta_mmol ~ treatment, data = grdata)
 summary(treat_aov_2)

TAemmean<-cld(emmeans(treat_aov_2, ~treatment), Letters = letters)
TAemmean
pairs(emmeans(treat_aov_2, ~treatment), adjust = "tukey")
#tukey_treat <- cld(TukeyHSD(treat_aov))
#print(tukey_treat)


```
## Calcification 
### Linear models
```{r}
#BW mixed effect linear model 
LM_BWTA2 <- lmerTest::lmer(gr_t1t3 ~ avg_ta_mmol + (1|geno) + (1|tank), data = grdata)
summary(LM_BWTA2)
anova(LM_BWTA2)
ranova(LM_BWTA2)
step(LM_BWTA2)
plot(LM_BWTA2)
```

Using the timepoint after the lights were fixed eliminates the tank effect.  

Simplest linear model: 
```{r}
LM_BWTA2a <- lm(gr_t1t3 ~ avg_ta_mmol, data = grdata)
summary(LM_BWTA2a)
anova(LM_BWTA2a)
plot(LM_BWTA2a)

bw_slope <- coef(LM_BWTA2a)["avg_ta_mmol"]
bw_intercept <- coef(LM_BWTA2a)[1]  # Intercept
bw_summary_model <- summary(LM_BWTA2a)
bw_r_squared <- summary(LM_BWTA2a)$r.squared
bw_pvalue <- summary(LM_BWTA2a)$coefficients[2, 4]


print(paste("R-Squared:", bw_r_squared))
print(paste("slope:", bw_slope))
print(paste("p = ",bw_pvalue))
print(paste("intercept: ",bw_intercept))

```
## Linear Extension 
### Linear models 
```{r}
#LE mixed effect linear model t1-t3
LM_LETA2 <- lmerTest::lmer(le_t1t3e ~ avg_ta_mmol + (1|geno) + (1|tank), data = grdata)
summary(LM_LETA2)
anova(LM_LETA2)
ranova(LM_LETA2)
step(LM_LETA2)
plot(LM_LETA2)
```


 
no genotype effect  
Simplest linear model: 
```{r}
LM_LETA2a <- lm(le_t1t3e ~ avg_ta_mmol, data = grdata)
summary(LM_LETA2a)
anova(LM_LETA2a)
plot(LM_LETA2a)

le_slope <- coef(LM_LETA2a)["avg_ta_mmol"]
le_intercept <- coef(LM_LETA2a)[1]  # Intercept
le_summary_model <- summary(LM_LETA2a)
le_r_squared <- summary(LM_LETA2a)$r.squared
le_pvalue <- summary(LM_LETA2a)$coefficients[2, 4]



le_summary_model




print(paste("R-Squared:", le_r_squared))
print(paste("slope:", le_slope))
print(paste("p = ",le_pvalue))
print(paste("intercept: ", le_intercept))
```


## Figures  
### Assign Colors/Generate Treat Names/Label groups  
```{r}
#re-define treatment names HERE
#color pallette to assign treatments 
treatment_colors <- c(
  AMB = "#52dcbf",   # Light blue
  ELEV = "#1fa1d5",  # You can adjust this color
  HI = "#9d3aa6",    # You can adjust this color
  XHI =  "#6b348f"  )  # Coral

#define custom labels for genotype
labels_genotype <- c("C" = "Coopers",
                     "M" = "Marker 9",
                     "S" = "Sunny Isles")
ta_summary <- bottle_d %>%
  group_by(Treatment) %>%
  summarise(
    mean_ta = mean(Avg.TA),
    sem_ta = sd(Avg.TA) / sqrt(n())
  )
print(ta_summary)

dose_names <- c("AMB" = "ambient", "ELEV" = "+1200 µM", "HI" = "+1850 µM", "XHI" = "+2000 µM")

```

### TA_TimeXTreat
#### Boxplot 
```{r}
#boxplot 
 

# Create a summary table for sample sizes
sample_sizes <- bottle_d %>%
  group_by(Treatment) %>%
  summarise(n = n(), 
            lower_whisker = quantile(Avg.TA, 0.25, na.rm = TRUE))  # Get Q1 for placement

y_limits <- c(min(bottle_d$Avg.TA), max(bottle_d$Avg.TA))  # Set y-axis limits

box_ta <- ggplot(bottle_d, aes(x = Treatment, y = Avg.TA, fill = Treatment)) +
  geom_boxplot() +
  ylab(NULL) +
  xlab("Treatment") +
  scale_x_discrete(labels = dose_names) +
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  theme(
    axis.title.x = element_text(size = 20),    
    axis.title.y = element_text(size = 20),    
    axis.text = element_text(size = 19),       
    legend.text = element_text(size = 16),     
    legend.title = element_text(size = 18)     
  ) +
  scale_fill_manual(values = treatment_colors, labels = dose_names) +
  labs(colour = expression(Treatment ~ A[ T ]), fill = expression(Treatment ~ A[ T ])) +

  # Adding "a, b, c" labels above the boxplots
  geom_text(aes(x = "AMB", y = max(bottle_d$Avg.TA[bottle_d$Treatment == "AMB"]), label = "a"), 
            vjust = -0.5, size = 5, color = "black") +
  geom_text(aes(x = "ELEV", y = max(bottle_d$Avg.TA[bottle_d$Treatment == "ELEV"]), label = "b"), 
            vjust = -0.5, size = 5, color = "black") +
  geom_text(aes(x = "HI", y = max(bottle_d$Avg.TA[bottle_d$Treatment == "HI"]), label = "c"), 
            vjust = -0.5, size = 5, color = "black") +
  geom_text(aes(x = "XHI", y = max(bottle_d$Avg.TA[bottle_d$Treatment == "XHI"]), label = "c"), 
            vjust = -0.5, size = 5, color = "black") +

  # Adding "n=xx" inside the lower right of the boxes (Q1 position)
  geom_text(data = sample_sizes, 
            aes(x = Treatment, y = lower_whisker, label = paste0("n=", n)), 
            hjust = 1.1, vjust = 1.2, size = 4.2, color = "black") +

  coord_cartesian(ylim = y_limits)

box_ta


```

#### Scatter_Time
```{r}
# Summarize the data to create mean and std dev for each day by treatment
#convert date column to "Date" type.
bottle_d$Date <- as.Date(bottle_d$Date, format = "%m/%d/%Y")

# Get the unique dates from the data
unique_dates <- unique(bottle_d$Date)
summary_data <- bottle_d %>%
  group_by(Date, Treatment) %>%
  summarise(
    mean_ta = mean(Avg.TA),
    se_ta = sd(Avg.TA) / sqrt(n())
  ) %>%
  ungroup()


# Plot the summarized data

treat_stab <- ggplot(bottle_d, aes(x = Date, y = Avg.TA)) +
  # Scatter points: jittered points with color (Treatment) and shape (Coral Type)
  geom_jitter(aes(colour = Treatment), alpha = 0.3) +
  
  # Error bars (Mean ± CI)
  stat_summary(aes(x = Date, y = Avg.TA, colour = Treatment),
               fun.data = "mean_cl_boot", geom = "errorbar", 
               width = 0.2, position = position_dodge(width = 1)) +

  # Mean points (Summary points with Treatment color)
  stat_summary(aes(x = Date, y = Avg.TA, colour = Treatment, fill = Treatment, shape = ifelse(Coral == "Blank", "Blank", "Coral")),
               size = 4, fun.data = "mean_cl_boot", geom = "point",
               position = position_dodge(width = 1)) +

  # X-axis formatting
  scale_x_date(breaks = unique_dates, date_labels = "%b %d") +
  ylab(expression(Total~alkalinity ~ (mu*mol~kg^-1))) +
  
  # Theme adjustments
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 65, hjust = 1),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        axis.text = element_text(size = 19),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18)) +

  # Treatment colors
  scale_colour_manual(values = treatment_colors, labels = dose_names) +
  scale_fill_manual(values = treatment_colors, labels = dose_names) +

  # Shape legend (Triangles for Blanks, Circles for others)
  scale_shape_manual(values = c("Blank" = 1, "Coral" = 16), name = "Beaker content") +

  # Hiding shape from the Treatment legend (only circles show there)
  guides(shape = guide_legend(order = 2), colour = guide_legend(order = 1), fill = "none") +

  # Legends labeling
  labs(colour = expression(Treatment ~ A[ T ]), 
       fill = expression(Treatment ~ A[ T ]), 
       shape = "Coral Type") + 

  # Limit y-axis range
  coord_cartesian(ylim = y_limits)

treat_stab

```

#### TA_Summary_Plot

```{r}

TA_summary_plot <- ggarrange(
  treat_stab + theme(legend.position = "right", plot.margin = margin(5, 5, 50, 5)),  
  box_ta + theme(legend.position = "none"),
  labels = c("A", "B"),
  ncol = 2, nrow = 1, widths = c(4, 2), align = "h",
  common.legend = TRUE, legend = "right"
)


TA_summary_plot

```


### Calcification 
#### Subplots
```{r}

#Generate group CLD letters
bw_aov <- lm(gr_t1t3 ~ treatment, data = grdata)
 summary(bw_aov)
 
BWemmean<-cld(emmeans(bw_aov, ~treatment), Letters = letters)

BWemmean 

pairs(emmeans(bw_aov, ~treatment), adjust = "tukey")

bwcld <- grdata %>%
  group_by(treatment) %>%
  summarise(max_value = max(gr_t1t3)) %>%
    mutate(
    label = c("a", "b", "b", "b"),
    max_value = if_else(treatment == "HI", 0.87, max_value)  # Manually set max_value for +1750 µm
  )

#Calc summary boxplot
bw_boxsum <- ggplot(grdata, aes(x=treatment, y=gr_t1t3, fill=treatment))+
  geom_boxplot()+
  ylab(NULL) +
  xlab("Treatment")+
  scale_x_discrete(labels = dose_names)+
  theme_classic(base_size = 14)+
  theme(plot.margin=unit(c(1,1,1,1), 'cm'))+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+
   theme(
    axis.title.x = element_text(size = 20),    # Increase X-axis title size
    axis.title.y = element_text(size = 20),    # Increase Y-axis title size
    axis.text = element_text(size = 19),       # Increase axis label text size
    legend.text = element_text(size = 16),     # Optionally adjust legend text size
    legend.title = element_text(size = 18)     # Optionally adjust legend title size
  ) +
  scale_fill_manual(values = treatment_colors, labels = dose_names)+
  labs(colour = expression(Treatment ~ A[ T ]), fill =  expression(Treatment ~ A[ T ]))+
  geom_text(data = bwcld, aes(x = treatment, y = max_value, label = label), 
            vjust = -0.5, size = 5)


bw_boxsum



# Create scatter plot 
bw_scat <- ggplot(data = grdata, aes(x = avg_ta, y = gr_t1t3, colour = treatment)) +
  geom_point(size = 2, aes(shape = geno)) +
  geom_smooth(color = 1, method = 'lm', se = TRUE, linetype = "dashed") +
   scale_colour_manual(values = treatment_colors, labels = dose_names ) +  # Use scale_colour_manual to apply treatment_colors
  scale_shape_discrete(labels = labels_genotype) +  # Apply labels to the genotype legend
  xlab(expression(Total~alkalinity ~ (mu*mol~kg^-1))) +
  ylab(expression(Calcification~rate~(mg~cm^-2~day^-1))) + 
   labs(colour = expression(Treatment ~ A[ T ]), fill =  expression(Treatment ~ A[ T ]), shape = "Genotype")+
  theme_classic(base_size = 14) + 
   theme(
    axis.title.x = element_text(size = 20),# Increase X-axis title size
    axis.title.y = element_text(size = 20),    # Increase Y-axis title size
    axis.text = element_text(size = 19),       # Increase axis label text size
    legend.text = element_text(size = 16),     # Optionally adjust legend text size
    legend.title = element_text(size = 18),
    legend.position = c(0.8, 0.15),
    legend.box = "vertical") +
  guides(
    shape = guide_legend(order = 2),   # Move Genotype to the top
    colour = guide_legend(order = 1)   # Move Treatment below it
  ) +
  
  annotate("text", x = 3020, y = 1.2,
           label = paste("slope =", round(bw_slope, 2), " R² =", round(bw_r_squared, 3), " p < 0.00001"), 
           color = "black", size = 7,
           fontface = "bold")


  

bw_scat

```

#### Calcification_Summary_Plot
```{r}

library(ggpubr)  # Ensure ggpubr is loaded
bw_scat <- bw_scat + theme(axis.title.x = element_text(hjust = 0.5, vjust = 3))

bw_summary_plot <- ggarrange(
  bw_scat,
  bw_boxsum + theme(legend.position = "top"),
  labels = c("A", "B"),
  ncol = 2, nrow = 1, widths = c(4, 2),
  align = "h",
  common.legend = TRUE, legend = "right"
)

bw_summary_plot
```

### Linear Extension
#### Subplots
```{r}
#Generate group CLD letters


le_ta <- lm(le_t1t3e ~avg_ta, data = growth_2000)
summary(le_ta)
le_aov <- lm(le_t1t3e ~ treatment, data = growth_all)
summary(le_aov)
 
LEemmean<-cld(emmeans(le_aov, ~treatment), Letters = letters)

LEemmean 

lecld <- grdata %>%
  group_by(treatment) %>%
  summarise(max_value = max(le_t1t3e)) %>%
  mutate(label = c("a", "a", "a", "a"))  # Your specific labels



```

LE boxplot summary
```{r}
le_box <- ggplot(grdata, aes(x= treatment, y = le_t1t3e, fill = treatment))+
                   geom_boxplot()+
  ylab(NULL) +
  xlab("Treatment")+
  scale_x_discrete(labels = dose_names)+
  theme_classic(base_size = 14)+
  theme(plot.margin=unit(c(1,1,1,1), 'cm'))+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+
   theme(
    axis.title.x = element_text(size = 20),    # Increase X-axis title size
    axis.title.y = element_text(size = 20),    # Increase Y-axis title size
    axis.text = element_text(size = 19),       # Increase axis label text size
    legend.text = element_text(size = 16),     # Optionally adjust legend text size
    legend.title = element_text(size = 18),
    # Optionally adjust legend title size
  ) +
  scale_fill_manual(values = treatment_colors, labels = dose_names)+
  labs(colour = expression(Treatment ~ A[ T ]), fill =  expression(Treatment ~ A[ T ]))+
   geom_text(data = lecld, aes(x = treatment, y = max_value, label = label), 
            vjust = -0.5, size = 5)+
   coord_cartesian(ylim = c(min(grdata$le_t1t3e), max(grdata$le_t1t3e)))


le_box
                   
```

LE scatter plot

```{r}
# Create scatter plot 
le_scat <- ggplot(data = grdata, aes(x = avg_ta, y = le_t1t3e, colour = treatment)) +
  geom_point(size = 2, aes(shape = geno)) +
  geom_smooth(color = 1, method = 'lm', se = TRUE, linetype = "dashed") +
  scale_colour_manual(values = treatment_colors, labels = dose_names) +  # Use scale_colour_manual to apply treatment_colors
  scale_shape_discrete(labels = labels_genotype) +  # Apply labels to the genotype legend
  xlab(expression(Total~alkalinity ~ (mu*mol~kg^-1))) + 
  ylab(expression(Linear~extension~(mm~day^-1))) + 
  labs(colour = expression(Treatment ~ A[ T ]), fill =  expression(Treatment ~ A[ T ]), shape = "Genotype")+
  theme_classic(base_size = 14) +
   theme(
    axis.title.x = element_text(size = 20),    # Increase X-axis title size
    axis.title.y = element_text(size = 20),    # Increase Y-axis title size
    axis.text = element_text(size = 19),       # Increase axis label text size
    legend.text = element_text(size = 16),     # Optionally adjust legend text size
    legend.title = element_text(size = 18),
    legend.position = c(0.8, 0.15),
    legend.box = "vertical"# Optionally adjust legend title size
  ) +
  guides(
    shape = guide_legend(order = 2),   # Move Genotype to the top
    colour = guide_legend(order = 1)   # Move Treatment below it
  ) +
  coord_cartesian(ylim = c(min(grdata$le_t1t3e), max(grdata$le_t1t3e))) +  # Explicitly set y-axis limits
  annotate("text", x = 3000, y = 0.13, 
           label = paste("slope =", round(le_slope, 2), " R² =", round(le_r_squared, 3), " p =", signif(le_pvalue, 3)), 
           color = "black", size = 7, fontface = "bold")

le_scat

```

#### LinearExtension_Summary_Plot  

```{r}
le_scat <- le_scat + theme(axis.title.x = element_text(hjust = 0.5, vjust = 3))

le_summary_plot <- ggarrange(
  le_scat,
  le_box + theme(legend.position = "none"),
  labels = c("A", "B"),
  ncol = 2, nrow = 1, widths = c(4, 2),
  align = "h",
   common.legend = TRUE, legend = "right"
)

le_summary_plot

```

#### Growth X Time

Bw summary
```{r}
# Combine data for faceting
bwlong <- grdata %>%
  pivot_longer(cols = starts_with("gr_"), 
               names_to = "timepoint", 
               values_to = "growth_rate") %>%
   filter((timepoint %in% c("gr_t1t2", "gr_t2t3")))
  
  
y_limits <- range(c(bwlong$growth_rate, grdata$gr_t1t3))

bw_grxtime <- ggplot(bwlong, aes(x = timepoint, y = growth_rate, fill = treatment)) +
  geom_boxplot() +
  labs(x = "Timepoints", fill = "Dose (mL)") +
  ylab(expression(Calcification~(mg~cm^2^-1~day^-1))) +
  xlab(NULL)+
   scale_fill_manual(values = treatment_colors, labels = dose_names)+
  labs(colour = expression(Treatment ~ A[ T ]), fill =  expression(Treatment ~ A[ T ]))+
  scale_x_discrete(labels = c("Feb 19 - Mar 8","Mar 8 - Mar 23"))+
  theme_classic()
  

bw_grxtime

```
LE summary
```{r}
# Convert the data from wide format to long format
lelong <- grdata %>%
  pivot_longer(cols = starts_with("le_"), 
               names_to = "timepoint", 
               values_to = "growth_rate") %>%
   filter((timepoint %in% c("le_t1t2e", "le_t2t3e")))
  

# Determine the y-axis limits
y_limits <- range(c(lelong$growth_rate, grdata$le_t1t3e))

le_grxtime <- ggplot(lelong, aes(x = timepoint, y = growth_rate, fill = treatment)) +
  geom_boxplot() +
  labs(colour = expression(Treatment ~ A[ T ]), fill =  expression(Treatment ~ A[ T ]))+
  xlab(NULL)+
   ylab(expression(Linear~Extension~(mm~day^-1))) +
  theme_classic() +
     scale_fill_manual(values = treatment_colors, labels = dose_names) +
  scale_x_discrete(labels = c("Feb 19 - Mar 8","Mar 8 - Mar 23"))

le_grxtime
```

```{r}
grxtime_summary <- ggarrange(
  bw_grxtime + theme(legend.position = "right",axis.text.x = element_blank(), axis.ticks.x = element_blank()),
  le_grxtime + theme(legend.position = "none"),
  labels = c("A", "B"),
  ncol = 1, nrow = 2,
  align = "v"
)

grxtime_summary
```

Growth over time -- regression 

```{r}
# Find the common y-axis range
y_min <- min(grdata$gr_t1t2, grdata$gr_t2t3, grdata$le_t1t2e, grdata$le_t2t3e, na.rm = TRUE)
y_max <- max(grdata$gr_t1t2, grdata$gr_t2t3, grdata$le_t1t2e, grdata$le_t2t3e, na.rm = TRUE)

# Calcification Rate Plot
bw_grxtime_r <- ggplot(grdata, aes(x = avg_ta, y = gr_t1t2)) +
  geom_point(aes(color = "gr_t1t2"), size = 2) +
  geom_smooth(aes(color = "gr_t1t2"), method = 'lm', se = TRUE) +
  geom_point(data = grdata, aes(x = avg_ta, y = gr_t2t3, color = "gr_t2t3"), size = 2) +  
  geom_smooth(data = grdata, aes(x = avg_ta, y = gr_t2t3, color = "gr_t2t3"), method = 'lm', se = TRUE) +  
  scale_color_manual(name = "Growth period", values = c("gr_t1t2" = "blue2", "gr_t2t3" = "firebrick2"), labels = c("Feb 19 to Mar 8", "Mar 8 to Mar 28")) +
  xlab(expression(Total~alkalinity ~ (mu~mol~kg^-1))) +
  ylab(expression(Calcification~rate~(mg~cm^2 ^-1~day^-1))) +
  ylim(y_min, y_max) +  # Set consistent y-axis scale
  theme_classic(base_size = 14) +
  theme(
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text = element_text(size = 19),
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 18)
  )

# Linear Extension Plot
le_grxtime_r <- ggplot(grdata, aes(x = avg_ta, y = le_t1t2e)) +
  geom_point(aes(color = "le_t1t2e"), size = 2) +
  geom_smooth(aes(color = "le_t1t2e"), method = 'lm', se = TRUE) +
  geom_point(data = grdata, aes(x = avg_ta, y = le_t2t3e, color = "le_t2t3e"), size = 2) +  
  geom_smooth(data = grdata, aes(x = avg_ta, y = le_t2t3e, color = "le_t2t3e"), method = 'lm', se = TRUE) +  
  scale_color_manual(name = "Growth period", values = c("le_t1t2e" = "blue2", "le_t2t3e" = "firebrick2"), labels = c("Feb 19 to Mar 8", "Mar 8 to Mar 28")) +
  xlab(expression(Total~alkalinity ~ (mu~mol~kg^-1))) +
  ylab(expression(Linear~Extenion~(mm~~day^-1))) +
  ylim(y_min, y_max) +  # Set consistent y-axis scale
  theme_classic(base_size = 14) +
  theme(
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text = element_text(size = 19),
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 18)
  )

# Join Figures with Aligned Y-Axis
grxtime_r_summary <- ggarrange(
  bw_grxtime_r + theme(legend.position = c(0.2, 0.8)),
  le_grxtime_r + theme(legend.position = "none"),
  labels = c("A", "B"),
  ncol = 2, nrow = 1, widths = c(2, 2),
  align = "hv"  # Ensure both horizontal and vertical alignment
)

grxtime_r_summary

```


Percent change in growth calculated from slopes
```{r}

# Calculate average growth rates for the two periods
growth_summary <- grdata %>%
  summarize(
    avg_gr_t1t2 = mean(gr_t1t2, na.rm = TRUE), # First half
    avg_gr_t2t3 = mean(gr_t2t3, na.rm = TRUE)  # Second half
  )

# Compute percent decrease
growth_summary <- growth_summary %>%
  mutate(percent_decrease = ((avg_gr_t1t2 - avg_gr_t2t3) / avg_gr_t1t2) * 100)

print(growth_summary)

linear_extension_summary <- grdata %>%
  summarize(
    avg_le_t1t2e = mean(le_t1t2e, na.rm = TRUE), # First half
    avg_le_t2t3e = mean(le_t2t3e, na.rm = TRUE)  # Second half
  ) %>%
  mutate(percent_decrease = ((avg_le_t1t2e - avg_le_t2t3e) / avg_le_t1t2e) * 100)

print(linear_extension_summary)

```